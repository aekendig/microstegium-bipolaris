---
title: "Model Description"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(tidyverse)
library(brms)
library(tidybayes)
library(kableExtra)
library(deSolve)
library(cowplot)
```

# Continuous time model
This model describes changes in the biomass of annuals ($A$), first-year perennials ($F$), and adult perennials ($P$) over the growing season. Biomass is affected by disease and competition. We assume all biomass belonging to one plant group (e.g., stems, leaves, etc.) experiences the same growth rate, competitive effects, and disease transmission. The biomass of plant group $i$, where $i = A, F, P$, can either be susceptible ($S$) or infected ($I$). The total biomass of a plant group is $B$ and inoculum in the litter produced by annuals is $l$. Inoculum is lost from the litter over the growing season as rate $h$.      

\begin{equation}
\begin{gathered}
dB_{i}/dt = r_{i}B_{i}(1 - \alpha_{iA}B_{A} - \alpha_{iF}B_{F} - \alpha_{iP}B_{P}) - v_{i}I_{i}
\\
dI_{i}/dt = \frac{\beta_{il}S_{i}l + \beta_{iA}S_{i}I_{A} + \beta_{iF}S_{i}I_{F} + \beta_{iP}S_{i}I_{P}}{k_{i} + B_{i}} - v_{i}I_{i}
\\
dl/dt = -hl
\\
B_{i,t} = S_{i,t} + I_{i,t}
\end{gathered}
\end{equation}

Total biomass grows at a rate $r_{i}$, which is slowed due to competition ($\alpha$ values). Infection ($\beta$ values) moves biomass from the susceptible to infected category. Transmission is asymptotic (Antonovics et al. 1995, McCallum et al. 2001) to represent saturating contact rates with increasing density. Both susceptible and infected biomass contribute to competition because susceptible biomass contributes to photosynthesis and resource uptake and both types of biomass contribute to shading. Infected biomass does not grow, but is converted from susceptible biomass. Infected biomass is lost at a rate $v_{i}$ due to processes such as shedding or cell death.   

We simulate the continuous time model for the number of days in a growing season ($T$). The initial states of the variables are derived from the discrete time model and described below.  

# Discrete time model
This model describes annual changes in the population densities of annual plant seeds ($A$), perennial plant seeds ($F$), and perennial adult plants ($P$).  

Because we found that infected annual seeds have reduced germination, we separately track susceptible $A_{S}$ and infected $A_{I}$ annual seeds. Susceptible annual seeds either stay dormant in the seed bank or germinate ($g_{S}$) while infected seeds can only germinate at a reduced fraction ($g_{I}$) and do not survive for another year in the seed bank. If seeds germinate, they establish and grow regardless of whether they are infected. The seeds that germinate and establish are used to initiate the continuous time model ($S_{A,0}$) with initial biomass $b_{A}$. The final biomass of annual plants in the continuous time model ($B_{A,T}$) is used to estimate seed production with a conversion constant $c_{A}$. We assume a fraction $p$ of the seeds produced are infected, based on the empirical relationship between leaf severity (Estimated with $I_{A,T}/B_{A,T}$) and seed infection. Each gram of annual litter ($L$) reduces the establishment of annuals ($E_{A}$) by $\gamma_{A}$.

\begin{equation}
\begin{gathered}
A_{S}[t+1] = s_{A}(1 - g_{S})A_{S}[t] + (1-p)c_{A}B_{A,T}[t]
\\
A_{I}[t+1] = pc_{A}B_{A,T}[t]
\\
S_{A,0} = g_{S}E_{A}b_{A}A_{S}[t] + g_{I}E_{A}b_{A}A_{I}[t]
\\
p = \frac{e^{p_{0} + p_{1}I_{A,T}[t]/B_{A,T}[t]}}{1 + e^{p_{0} + p_{1}I_{A,T}[t]/B_{A,T}[t]}}
\\
E_{A} = e_{A}/(1 + \gamma_{A}L[t])
\end{gathered}
\end{equation}

The processes the determine perennial plant seeds are similar to those for annual plant seeds except that perennial seeds can be produced either by first year plants or by adults.

\begin{equation}
\begin{gathered}
F[t+1] = s_{P}(1 - g_{P})F[t] + c_{F}B_{F,T}[t] + c_{P}B_{P,T}[t]
\\
S_{F,0} = g_{P}E_{P}b_{F}F[t]
\\
E_{P} = e_{P}/(1 + \gamma_{P}L[t])
\end{gathered}
\end{equation}

Perennial adult plants are either adults  that survived through the year or seeds that germinated, established, and survived through the non-growing season (e.g., winter).

\begin{equation}
\begin{gathered}
P[t+1] = l_{P}P[t] + g_{P}E_{P}w_{F}F[t]
\\
S_{P,0} = b_{P}P[t]
\end{gathered}
\end{equation}

The litter is composed of litter remaining from the previous year and new litter produced by annuals. Infected annual biomass from the previous year becomes the inoculum source at the beginning of the growing season.

\begin{equation}
\begin{gathered}
L[t+1] = (1 - d)L[t] + B_{A,T}[t]
\\
l_{0} = I_{A,T}[t-1]
\end{gathered}
\end{equation}

# Parameters

```{r parameters, include=FALSE}
#### growth ####

# load model
load("../output/focal_growth_density_model_2019_density_exp.rda")

# does fungicide significantly affect growth rates?
# note that these only apply when Mv is the background plant, although its density is 0
r_A_hyp = "fungicide = 0"
r_F_hyp = "fungicide + focs:fungicide = 0"
r_P_hyp = "fungicide + foca:fungicide = 0"

hypothesis(growthD2Mod, c(r_A_hyp, r_F_hyp, r_P_hyp))
# yes, fungicide significantly lowers perennial adult growth rate
# use control values

# does fungicide significantly affect growth rates?
# assessed in focal_growth_2018_2019_density_exp.R
# yes, some competition coefficients for perennial adults are only significant with fungicide
# let's assume these could also apply with ctrl conditions

# Stricker data (for alpha_AA)
# stricker <- read_csv("../intermediate-data/stricker_2016_extracted_figure.csv")
# max biomass is a fungicide treated plot

# growth rates and competition coefficients
growth_mod_parms <- posterior_samples(growthD2Mod)  %>%
  rename_with(str_replace_all, pattern = ":", replacement = "_") %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(r_A = Intercept,
            r_F = Intercept + focs,
            r_P = Intercept + foca,
            alpha_AA = - 1 * density,
            # alpha_AA = 1/max(stricker$biomass_g_m2),
            alpha_FA = - 1 * (density + density_focs),
            alpha_PA = - 1 * (density + density_foca),
            alpha_AF = - 1 * (density + density_bgs + density_fungicide + density_bgs_fungicide),
            alpha_FF = - 1 * (density + density_focs + density_bgs + density_focs_bgs),
            alpha_PF = - 1 * (density + density_foca + density_bgs + density_foca_bgs),
            alpha_AP = - 1 * (density + density_bga + density_fungicide + density_bga_fungicide),
            alpha_FP = - 1 * (density + density_bga + density_focs + density_focs_bga + density_fungicide + density_bga_fungicide + density_focs_fungicide + density_focs_bga_fungicide),
            alpha_PP = - 1 * (density + density_foca + density_bga + density_foca_bga)) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual-annual competition",
                            "annual-first-year perennial competition",
                            "annual-adult perennial competition",
                            "first-year perennial-annual competition",
                            "first-year perennial-first-year perennial competition",
                            "first-year perennial-adult perennial competition",
                            "adult perennial-annual competition",
                            "adult perennial-first-year perennial competition",
                            "adult perennial-adult perennial competition",
                            "annual growth rate",
                            "perennial first-year growth rate",
                            "perennial adult growth rate"),
            Estimate = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ estimate/160, # r_F not sig, but we need an estimate
                                 .lower < 0 & .upper > 0 ~ 0,
                                 TRUE ~ estimate),
            Lower = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ .lower/160,
                              #parameter == "alpha_AA" ~ NA_real_, # not estimated with replicates
                              .lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .lower),
            Upper = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ .upper/160,
                              #parameter == "alpha_AA" ~ NA_real_,
                              .lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .upper),
            Units = c(rep("g^-1^", 9), rep("day^-1^", 3)),
            Source = "experiment")


#### transmission ####

# load model
load("../output/plot_transmission_model_2019_density_exp.rda")

# does fungicide significantly affect transmission rates?
# assessed in plot_severity_model_2018_2019_density_exp.R
# yes, some transmission to Ev seedlings are only significant with fungicide
# let's assume these could also apply with ctrl conditions

# transmission rates
trans_mod_parms <- posterior_samples(sevD2Mod)  %>%
  rename_with(str_replace_all, pattern = ":", replacement = "_") %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(beta_AA = bg_severity,
            beta_FA = bg_severity + bg_severity_fungicide + bg_severity_focs + bg_severity_focs_fungicide,
            beta_PA = bg_severity + bg_severity_foca,
            beta_AF = bg_severity + bg_severity_bgs,
            beta_FF = bg_severity + bg_severity_focs + bg_severity_bgs + bg_severity_focs_bgs,
            beta_PF = bg_severity + bg_severity_foca + bg_severity_bgs + bg_severity_foca_bgs,
            beta_AP = bg_severity + bg_severity_bga,
            beta_FP = bg_severity + bg_severity_bga + bg_severity_focs + bg_severity_focs_bga + bg_severity_fungicide + bg_severity_bga_fungicide + bg_severity_focs_fungicide + bg_severity_focs_bga_fungicide,
            beta_PP = bg_severity + bg_severity_foca + bg_severity_bga + bg_severity_foca_bga) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual-annual transmission",
                            "annual-first-year perennial transmission",
                            "annual-adult perennial transmission",
                            "first-year perennial-annual transmission",
                            "first-year perennial-first-year perennial transmission",
                            "first-year perennial-adult perennial transmission",
                            "adult perennial-annual transmission",
                            "adult perennial-first-year perennial transmission",
                            "adult perennial-adult perennial transmission"),
            Estimate = case_when(.lower < 0 & .upper > 0 ~ 0,
                                 TRUE ~ estimate/30), # days between censuses
            Lower = case_when(.lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .lower/30),
            Upper = case_when(.lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .upper/30),
            Units = "day^-1^ g^-1^",
            Source = "experiment")


#### seed infection ####

load("../output/mv_seed_infection_dark_model_2018_density_exp.rda")

seed_inf_parms <- posterior_samples(mvPropDarkMod)  %>%
  transmute(p0 = b_Intercept,
            p1 = b_sep_severity) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("seed infection parameter",
                            "seed infection parameter"),
            Estimate = round(estimate, 3),
            Lower = round(.lower, 3),
            Upper = round(.upper, 3),
            Units = "NA",
            Source = "experiment")


#### germination ####

load("../output/mv_germination_infection_model_2018_density_exp.rda")

mv_germ_parms <- posterior_samples(mvGermD1Mod)  %>%
  transmute(g_S = exp(b_Intercept)/(1 +  exp(b_Intercept)),
            g_I = exp(b_Intercept + b_prop_dark)/(1 +  exp(b_Intercept + b_prop_dark))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("infected annual germination fraction",
                            "susceptible annual germination fraction"),
            Estimate = round(estimate, 3),
            Lower = round(.lower, 3),
            Upper = round(.upper, 3),
            Units = "NA",
            Source = "experiment")

load("../output/ev_germination_severity_model_2018_2019_density_exp.rda")

ev_germ_parms <- posterior_samples(evGermMod)  %>%
  transmute(g_P = exp(b_Intercept)/(1 +  exp(b_Intercept))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("perennial germination fraction"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### seeds per biomass ####

load("../output/mv_seeds_per_biomass_untransformed_model_2019_density_exp.rda")
load("../output/evS_seeds_per_biomass_untransformed_model_2019_density_exp.rda")
load("../output/evA_seeds_per_biomass_untransformed_model_2019_density_exp.rda")

mv_seed_parms <- posterior_samples(mvSeedsBioD2Mod2)  %>%
  transmute(c_A = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")

evS_seed_parms <- posterior_samples(evSSeedsBioD2Mod2)  %>%
  transmute(c_F = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("first-year perennial seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")

evA_seed_parms <- posterior_samples(evASeedsBioD2Mod2)  %>%
  transmute(c_P = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("adult perennial seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")


#### establishment ####

load("../output/survival_severity_model_2018_density_exp.rda")

est_mod_parms <- posterior_samples(survSevD1Mod)  %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(e_A = exp(Intercept)/(1 + exp(Intercept)),
            e_P = exp(Intercept + focs)/(1 + exp(Intercept + focs))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual establishment fraction",
                            "perennial establishment fraction"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### adult survival ####

load("../output/ev_adult_survival_model_2018_2019_density_exp.rda")

evA_surv_parms <- posterior_samples(adultSurvD1Mod)  %>%
  transmute(l_P = exp(b_Intercept)/(1 + exp(b_Intercept))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = "adult perennial survival fraction",
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### non-growing season survival ####

load("../output/winter_survival_severity_model_2018_density_exp.rda")

ngs_surv_parms <- posterior_samples(winSurvSevD1Mod)  %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(w_F = exp(Intercept + focs)/(1 + exp(Intercept + focs))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = "first-year perennial non-growing season survival fraction",
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### initial biomass ####

mvBioD2Dat <- read_csv("../data/mv_biomass_seeds_2019_density_exp.csv")
evBioD2Dat <- read_csv("../data/ev_biomass_seeds_oct_2019_density_exp.csv")

init_bio_parms <- tibble(Parameter = c("b_A", "b_F", "b_P"),
                         Description = c("annual initial biomass",
                                         "first-year perennial initial biomass",
                                         "adult perennial initial biomass"),
                         Estimate = c(min(mvBioD2Dat$biomass_weight.g, na.rm = T)/10,
                                      min(filter(evBioD2Dat, ID %in% c("1", "2", "3"))$weight, na.rm = T)/10,
                                      min(filter(evBioD2Dat, ID == "A")$weight, na.rm = T)/10), 
                         Lower = rep(NA_real_, 3), 
                         Upper = rep(NA_real_, 3), 
                         Units = rep("g", 3),
                         Source = rep("experiment", 3))


#### literature/estimated parameters ####

lit_parms <- tibble(Parameter = c("beta_Al", "beta_Fl", "beta_Pl", 
                                  "k_A", "k_F", "k_P",
                                  "v_A", "v_F", "v_P", 
                                  "h",
                                  "s_A", "s_P", 
                                  "gamma_A", "gamma_P", 
                                  "d"),
                    Description = c("litter transmission to annuals",
                                    "litter transmission to first-year perennials",
                                    "litter transmission to adult perennials",
                                    "transmission saturation constant for annuals",
                                    "transmission saturation constant for first-year perennials",
                                    "transmission saturation constant for adult perennials",
                                    "annual infected tissue loss",
                                    "perennial first-year infected tissue loss",
                                    "perennial adult infected tissue loss",
                                    "inoculum loss from litter",
                                    "annual surviving seed fraction",
                                    "perennial surviving seed fraction",
                                    "litter suppression of annuals",
                                    "litter suppression of perennial first-years",
                                    "annual litter decomposition fraction"),
                     Estimate = c(rep(0.01, 3), rep(10, 3), rep(1e-20, 3), 0.1, 0.15, 0.05, 0, 0, 0.59),
                     Source = c(rep("NA", 10), "Redwood et al. 2018", "Garrison and Stier 2010", "NA", "NA", "DeMeester and Richter 2010")) %>%
  mutate(Lower = NA_real_,
         Upper = NA_real_,
         Units = c(rep ("day^-1^ g^-1^", 3), rep ("g", 3), rep("day^-1^", 4), rep("NA", 2), rep("g^-1^", 2), "NA"))


#### combine ####
parms <- growth_mod_parms %>%
  full_join(trans_mod_parms) %>%
  full_join(seed_inf_parms) %>%
  full_join(mv_germ_parms) %>%
  full_join(ev_germ_parms) %>%
  full_join(mv_seed_parms) %>%
  full_join(evS_seed_parms) %>%
  full_join(evA_seed_parms) %>%
  full_join(est_mod_parms) %>%
  full_join(evA_surv_parms) %>%
  full_join(ngs_surv_parms) %>%
  full_join(init_bio_parms) %>%
  full_join(lit_parms)

write_csv(parms, "../output/discrete_continuous_model_parameters_2018_2019_density_exp.csv")
```

```{r parm-table, echo=FALSE, results='asis'}
kable(parms, digits = 3, align = c("l", "l", "c", "c", "c", "c", "c"))
```