---
title: "Model Description"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(tidyverse)
library(brms)
library(tidybayes)
library(kableExtra)
library(deSolve)
library(cowplot)
```

# Continuous time model
This model describes changes in the biomass of annuals ($A$), first-year perennials ($F$), and adult perennials ($P$) over the growing season. Biomass is affected by disease and competition. We assume all biomass belonging to one plant group (e.g., stems, leaves, etc.) experiences the same growth rate, competitive effects, and disease transmission. The biomass of plant group $i$, where $i = A, F, P$, can either be susceptible ($S$) or infected ($I$). The total biomass of a plant group is $B$ and inoculum in the litter produced by annuals is $l$. Inoculum is lost from the litter over the growing season as rate $h$.      

\begin{equation}
\begin{gathered}
dB_{i}/dt = r_{i}B_{i}(1 - \alpha_{iA}B_{A} - \alpha_{iF}B_{F} - \alpha_{iP}B_{P}) - v_{i}I_{i}
\\
dI_{i}/dt = \frac{\beta_{il}S_{i}l + \beta_{iA}S_{i}I_{A} + \beta_{iF}S_{i}I_{F} + \beta_{iP}S_{i}I_{P}}{k_{i} + B_{i}} - v_{i}I_{i}
\\
dl/dt = -hl
\\
B_{i,t} = S_{i,t} + I_{i,t}
\end{gathered}
\end{equation}

Total biomass grows at a rate $r_{i}$, which is slowed due to competition ($\alpha$ values). Infection ($\beta$ values) moves biomass from the susceptible to infected category. Transmission is asymptotic (Antonovics et al. 1995, McCallum et al. 2001) to represent saturating contact rates with increasing density. Both susceptible and infected biomass contribute to competition because susceptible biomass contributes to photosynthesis and resource uptake and both types of biomass contribute to shading. Infected biomass does not grow, but is converted from susceptible biomass. Infected biomass is lost at a rate $v_{i}$ due to processes such as shedding or cell death.   

We simulate the continuous time model for the number of days in a growing season ($T$). The initial states of the variables are derived from the discrete time model and described below.  

# Discrete time model
This model describes annual changes in the population densities of annual plant seeds ($A$), perennial plant seeds ($F$), and perennial adult plants ($P$).  

Because we found that infected annual seeds have reduced germination, we separately track susceptible $A_{S}$ and infected $A_{I}$ annual seeds. Susceptible annual seeds either stay dormant in the seed bank or germinate ($g_{S}$) while infected seeds can only germinate at a reduced fraction ($g_{I}$) and do not survive for another year in the seed bank. If seeds germinate, they establish and grow regardless of whether they are infected. The seeds that germinate and establish are used to initiate the continuous time model ($S_{A,0}$) with initial biomass $b_{A}$. The final biomass of annual plants in the continuous time model ($B_{A,T}$) is used to estimate seed production with a conversion constant $c_{A}$. We assume a fraction $p$ of the seeds produced are infected, based on the empirical relationship between leaf severity (Estimated with $I_{A,T}/B_{A,T}$) and seed infection. Each gram of annual litter ($L$) reduces the establishment of annuals ($E_{A}$) by $\gamma_{A}$.

\begin{equation}
\begin{gathered}
A_{S}[t+1] = s_{A}(1 - g_{S})A_{S}[t] + (1-p)c_{A}B_{A,T}[t]
\\
A_{I}[t+1] = pc_{A}B_{A,T}[t]
\\
S_{A,0} = g_{S}E_{A}b_{A}A_{S}[t] + g_{I}E_{A}b_{A}A_{I}[t]
\\
p = \frac{e^{p_{0} + p_{1}I_{A,T}[t]/B_{A,T}[t]}}{1 + e^{p_{0} + p_{1}I_{A,T}[t]/B_{A,T}[t]}}
\\
E_{A} = e_{A}/(1 + \gamma_{A}L[t])
\end{gathered}
\end{equation}

The processes the determine perennial plant seeds are similar to those for annual plant seeds except that perennial seeds can be produced either by first year plants or by adults.

\begin{equation}
\begin{gathered}
F[t+1] = s_{P}(1 - g_{P})F[t] + c_{F}B_{F,T}[t] + c_{P}B_{P,T}[t]
\\
S_{F,0} = g_{P}E_{P}b_{F}F[t]
\\
E_{P} = e_{P}/(1 + \gamma_{P}L[t])
\end{gathered}
\end{equation}

Perennial adult plants are either adults  that survived through the year or seeds that germinated, established, and survived through the non-growing season (e.g., winter).

\begin{equation}
\begin{gathered}
P[t+1] = l_{P}P[t] + g_{P}E_{P}w_{F}F[t]
\\
S_{P,0} = b_{P}P[t]
\end{gathered}
\end{equation}

The litter is composed of litter remaining from the previous year and new litter produced by annuals. Infected annual biomass from the previous year becomes the inoculum source at the beginning of the growing season.

\begin{equation}
\begin{gathered}
L[t+1] = (1 - d)L[t] + B_{A,T}[t]
\\
l_{0} = I_{A,T}[t-1]
\end{gathered}
\end{equation}

# Parameters

```{r parameters, include=FALSE}
#### growth ####

# load model
load("../output/focal_growth_density_model_2019_density_exp.rda")

# does fungicide significantly affect growth rates?
# note that these only apply when Mv is the background plant, although its density is 0
r_A_hyp = "fungicide = 0"
r_F_hyp = "fungicide + focs:fungicide = 0"
r_P_hyp = "fungicide + foca:fungicide = 0"

hypothesis(growthD2Mod, c(r_A_hyp, r_F_hyp, r_P_hyp))
# yes, fungicide significantly lowers perennial adult growth rate
# use control values

# does fungicide significantly affect growth rates?
# assessed in focal_growth_2018_2019_density_exp.R
# yes, some competition coefficients for perennial adults are only significant with fungicide
# let's assume these could also apply with ctrl conditions

# Stricker data (for alpha_AA)
# stricker <- read_csv("../intermediate-data/stricker_2016_extracted_figure.csv")
# max biomass is a fungicide treated plot

# growth rates and competition coefficients
growth_mod_parms <- posterior_samples(growthD2Mod)  %>%
  rename_with(str_replace_all, pattern = ":", replacement = "_") %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(r_A = Intercept,
            r_F = Intercept + focs,
            r_P = Intercept + foca,
            alpha_AA = - 1 * density,
            # alpha_AA = 1/max(stricker$biomass_g_m2),
            alpha_FA = - 1 * (density + density_focs),
            alpha_PA = - 1 * (density + density_foca),
            alpha_AF = - 1 * (density + density_bgs + density_fungicide + density_bgs_fungicide),
            alpha_FF = - 1 * (density + density_focs + density_bgs + density_focs_bgs),
            alpha_PF = - 1 * (density + density_foca + density_bgs + density_foca_bgs),
            alpha_AP = - 1 * (density + density_bga + density_fungicide + density_bga_fungicide),
            alpha_FP = - 1 * (density + density_bga + density_focs + density_focs_bga + density_fungicide + density_bga_fungicide + density_focs_fungicide + density_focs_bga_fungicide),
            alpha_PP = - 1 * (density + density_foca + density_bga + density_foca_bga)) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual-annual competition",
                            "annual-first-year perennial competition",
                            "annual-adult perennial competition",
                            "first-year perennial-annual competition",
                            "first-year perennial-first-year perennial competition",
                            "first-year perennial-adult perennial competition",
                            "adult perennial-annual competition",
                            "adult perennial-first-year perennial competition",
                            "adult perennial-adult perennial competition",
                            "annual growth rate",
                            "perennial first-year growth rate",
                            "perennial adult growth rate"),
            Estimate = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ estimate/160, # r_F not sig, but we need an estimate
                                 .lower < 0 & .upper > 0 ~ 0,
                                 TRUE ~ estimate),
            Lower = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ .lower/160,
                              #parameter == "alpha_AA" ~ NA_real_, # not estimated with replicates
                              .lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .lower),
            Upper = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ .upper/160,
                              #parameter == "alpha_AA" ~ NA_real_,
                              .lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .upper),
            Units = c(rep("g^-1^", 9), rep("day^-1^", 3)),
            Source = "experiment")


#### transmission ####

# load model
load("../output/plot_transmission_model_2019_density_exp.rda")

# does fungicide significantly affect transmission rates?
# assessed in plot_severity_model_2018_2019_density_exp.R
# yes, some transmission to Ev seedlings are only significant with fungicide
# let's assume these could also apply with ctrl conditions

# transmission rates
trans_mod_parms <- posterior_samples(sevD2Mod)  %>%
  rename_with(str_replace_all, pattern = ":", replacement = "_") %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(beta_AA = bg_severity,
            beta_FA = bg_severity + bg_severity_fungicide + bg_severity_focs + bg_severity_focs_fungicide,
            beta_PA = bg_severity + bg_severity_foca,
            beta_AF = bg_severity + bg_severity_bgs,
            beta_FF = bg_severity + bg_severity_focs + bg_severity_bgs + bg_severity_focs_bgs,
            beta_PF = bg_severity + bg_severity_foca + bg_severity_bgs + bg_severity_foca_bgs,
            beta_AP = bg_severity + bg_severity_bga,
            beta_FP = bg_severity + bg_severity_bga + bg_severity_focs + bg_severity_focs_bga + bg_severity_fungicide + bg_severity_bga_fungicide + bg_severity_focs_fungicide + bg_severity_focs_bga_fungicide,
            beta_PP = bg_severity + bg_severity_foca + bg_severity_bga + bg_severity_foca_bga) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual-annual transmission",
                            "annual-first-year perennial transmission",
                            "annual-adult perennial transmission",
                            "first-year perennial-annual transmission",
                            "first-year perennial-first-year perennial transmission",
                            "first-year perennial-adult perennial transmission",
                            "adult perennial-annual transmission",
                            "adult perennial-first-year perennial transmission",
                            "adult perennial-adult perennial transmission"),
            Estimate = case_when(.lower < 0 & .upper > 0 ~ 0,
                                 TRUE ~ estimate/30), # days between censuses
            Lower = case_when(.lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .lower/30),
            Upper = case_when(.lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .upper/30),
            Units = "day^-1^ g^-1^",
            Source = "experiment")


#### seed infection ####

load("../output/mv_seed_infection_dark_model_2018_density_exp.rda")

seed_inf_parms <- posterior_samples(mvPropDarkMod)  %>%
  transmute(p0 = b_Intercept,
            p1 = b_sep_severity) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("seed infection parameter",
                            "seed infection parameter"),
            Estimate = round(estimate, 3),
            Lower = round(.lower, 3),
            Upper = round(.upper, 3),
            Units = "NA",
            Source = "experiment")


#### germination ####

load("../output/mv_germination_infection_model_2018_density_exp.rda")

mv_germ_parms <- posterior_samples(mvGermD1Mod)  %>%
  transmute(g_S = exp(b_Intercept)/(1 +  exp(b_Intercept)),
            g_I = exp(b_Intercept + b_prop_dark)/(1 +  exp(b_Intercept + b_prop_dark))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("infected annual germination fraction",
                            "susceptible annual germination fraction"),
            Estimate = round(estimate, 3),
            Lower = round(.lower, 3),
            Upper = round(.upper, 3),
            Units = "NA",
            Source = "experiment")

load("../output/ev_germination_severity_model_2018_2019_density_exp.rda")

ev_germ_parms <- posterior_samples(evGermMod)  %>%
  transmute(g_P = exp(b_Intercept)/(1 +  exp(b_Intercept))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("perennial germination fraction"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### seeds per biomass ####

load("../output/mv_seeds_per_biomass_untransformed_model_2019_density_exp.rda")
load("../output/evS_seeds_per_biomass_untransformed_model_2019_density_exp.rda")
load("../output/evA_seeds_per_biomass_untransformed_model_2019_density_exp.rda")

mv_seed_parms <- posterior_samples(mvSeedsBioD2Mod2)  %>%
  transmute(c_A = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")

evS_seed_parms <- posterior_samples(evSSeedsBioD2Mod2)  %>%
  transmute(c_F = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("first-year perennial seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")

evA_seed_parms <- posterior_samples(evASeedsBioD2Mod2)  %>%
  transmute(c_P = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("adult perennial seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")


#### establishment ####

load("../output/survival_severity_model_2018_density_exp.rda")

est_mod_parms <- posterior_samples(survSevD1Mod)  %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(e_A = exp(Intercept)/(1 + exp(Intercept)),
            e_P = exp(Intercept + focs)/(1 + exp(Intercept + focs))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual establishment fraction",
                            "perennial establishment fraction"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### adult survival ####

load("../output/ev_adult_survival_model_2018_2019_density_exp.rda")

evA_surv_parms <- posterior_samples(adultSurvD1Mod)  %>%
  transmute(l_P = exp(b_Intercept)/(1 + exp(b_Intercept))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = "adult perennial survival fraction",
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### non-growing season survival ####

load("../output/winter_survival_severity_model_2018_density_exp.rda")

ngs_surv_parms <- posterior_samples(winSurvSevD1Mod)  %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(w_F = exp(Intercept + focs)/(1 + exp(Intercept + focs))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = "first-year perennial non-growing season survival fraction",
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### initial biomass ####

mvBioD2Dat <- read_csv("../data/mv_biomass_seeds_2019_density_exp.csv")
evBioD2Dat <- read_csv("../data/ev_biomass_seeds_oct_2019_density_exp.csv")

init_bio_parms <- tibble(Parameter = c("b_A", "b_F", "b_P"),
                         Description = c("annual initial biomass",
                                         "first-year perennial initial biomass",
                                         "adult perennial initial biomass"),
                         Estimate = c(min(mvBioD2Dat$biomass_weight.g, na.rm = T)/10,
                                      min(filter(evBioD2Dat, ID %in% c("1", "2", "3"))$weight, na.rm = T)/10,
                                      min(filter(evBioD2Dat, ID == "A")$weight, na.rm = T)/10), 
                         Lower = rep(NA_real_, 3), 
                         Upper = rep(NA_real_, 3), 
                         Units = rep("g", 3),
                         Source = rep("experiment", 3))


#### literature/estimated parameters ####

lit_parms <- tibble(Parameter = c("beta_Al", "beta_Fl", "beta_Pl", 
                                  "k_A", "k_F", "k_P",
                                  "v_A", "v_F", "v_P", 
                                  "h",
                                  "s_A", "s_P", 
                                  "gamma_A", "gamma_P", 
                                  "d"),
                    Description = c("litter transmission to annuals",
                                    "litter transmission to first-year perennials",
                                    "litter transmission to adult perennials",
                                    "transmission saturation constant for annuals",
                                    "transmission saturation constant for first-year perennials",
                                    "transmission saturation constant for adult perennials",
                                    "annual infected tissue loss",
                                    "perennial first-year infected tissue loss",
                                    "perennial adult infected tissue loss",
                                    "inoculum loss from litter",
                                    "annual surviving seed fraction",
                                    "perennial surviving seed fraction",
                                    "litter suppression of annuals",
                                    "litter suppression of perennial first-years",
                                    "annual litter decomposition fraction"),
                     Estimate = c(rep(0.01, 3), rep(10, 3), rep(1e-20, 3), 0.1, 0.15, 0.05, 0, 0, 0.59),
                     Source = c(rep("NA", 10), "Redwood et al. 2018", "Garrison and Stier 2010", "NA", "NA", "DeMeester and Richter 2010")) %>%
  mutate(Lower = NA_real_,
         Upper = NA_real_,
         Units = c(rep ("day^-1^ g^-1^", 3), rep ("g", 3), rep("day^-1^", 4), rep("NA", 2), rep("g^-1^", 2), "NA"))


#### combine ####
parms <- growth_mod_parms %>%
  full_join(trans_mod_parms) %>%
  full_join(seed_inf_parms) %>%
  full_join(mv_germ_parms) %>%
  full_join(ev_germ_parms) %>%
  full_join(mv_seed_parms) %>%
  full_join(evS_seed_parms) %>%
  full_join(evA_seed_parms) %>%
  full_join(est_mod_parms) %>%
  full_join(evA_surv_parms) %>%
  full_join(ngs_surv_parms) %>%
  full_join(init_bio_parms) %>%
  full_join(lit_parms)

write_csv(parms, "../output/discrete_continuous_model_parameters_2018_2019_density_exp.csv")
```

```{r parm-table, echo=FALSE, results='asis'}
kable(parms, digits = 3, align = c("l", "l", "c", "c", "c", "c", "c"))
```


# Simulations

## Continuous time model
```{r continuous-model, include=FALSE}
# continuous model
cont_mod_fun <- function(t, x, params) {
  
  # initial conditions
  LogB_A <- x[1]
  LogB_F <- x[2]
  LogB_P <- x[3]
  I_A <- x[4]
  I_F <- x[5]
  I_P <- x[6]
  l <- x[7]

  # parameters
  r_A <- as.numeric(params[params$Parameter == "r_A", "Estimate"])
  r_F <- as.numeric(params[params$Parameter == "r_F", "Estimate"])
  r_P <- as.numeric(params[params$Parameter == "r_P", "Estimate"])

  alpha_AA <- as.numeric(params[params$Parameter == "alpha_AA", "Estimate"])
  alpha_AF <- as.numeric(params[params$Parameter == "alpha_AF", "Estimate"])
  alpha_AP <- as.numeric(params[params$Parameter == "alpha_AP", "Estimate"])
  alpha_FA <- as.numeric(params[params$Parameter == "alpha_FA", "Estimate"])
  alpha_FF <- as.numeric(params[params$Parameter == "alpha_FF", "Estimate"])
  alpha_FP <- as.numeric(params[params$Parameter == "alpha_FP", "Estimate"])
  alpha_PA <- as.numeric(params[params$Parameter == "alpha_PA", "Estimate"])
  alpha_PF <- as.numeric(params[params$Parameter == "alpha_PF", "Estimate"])
  alpha_PP <- as.numeric(params[params$Parameter == "alpha_PP", "Estimate"])

  beta_Al <- as.numeric(params[params$Parameter == "beta_Al", "Estimate"])
  beta_Fl <- as.numeric(params[params$Parameter == "beta_Fl", "Estimate"])
  beta_Pl <- as.numeric(params[params$Parameter == "beta_Pl", "Estimate"])
  beta_AA <- as.numeric(params[params$Parameter == "beta_AA", "Estimate"])
  beta_AF <- as.numeric(params[params$Parameter == "beta_AF", "Estimate"])
  beta_AP <- as.numeric(params[params$Parameter == "beta_AP", "Estimate"])
  beta_FA <- as.numeric(params[params$Parameter == "beta_FA", "Estimate"])
  beta_FF <- as.numeric(params[params$Parameter == "beta_FF", "Estimate"])
  beta_FP <- as.numeric(params[params$Parameter == "beta_FP", "Estimate"])
  beta_PA <- as.numeric(params[params$Parameter == "beta_PA", "Estimate"])
  beta_PF <- as.numeric(params[params$Parameter == "beta_PF", "Estimate"])
  beta_PP <- as.numeric(params[params$Parameter == "beta_PP", "Estimate"])

  k_A <- as.numeric(params[params$Parameter == "k_A", "Estimate"])
  k_F <- as.numeric(params[params$Parameter == "k_F", "Estimate"])
  k_P <- as.numeric(params[params$Parameter == "k_P", "Estimate"])

  v_A <- as.numeric(params[params$Parameter == "v_A", "Estimate"])
  v_F <- as.numeric(params[params$Parameter == "v_F", "Estimate"])
  v_P <- as.numeric(params[params$Parameter == "v_P", "Estimate"])

  h <- as.numeric(params[params$Parameter == "h", "Estimate"])
  
  # derived values
  B_A <- exp(LogB_A)
  B_F <- exp(LogB_F)
  B_P <- exp(LogB_P)
  S_A <- B_A - I_A
  S_F <- B_F - I_F
  S_P <- B_P - I_P
  
  # model with asymptotic transmission
  dLogBAdt <- r_A * (1 - alpha_AA * B_A - alpha_AF * B_F - alpha_AP * B_P) - v_A * I_A / B_A
  dLogBFdt <- r_F * (1 - alpha_FA * B_A - alpha_FF * B_F - alpha_FP * B_P) - v_F * I_F / B_F
  dLogBPdt <- r_P * (1 - alpha_PA * B_A - alpha_PF * B_F - alpha_PP * B_P) - v_P * I_P / B_P
  dIAdt <- (beta_Al * S_A * l + beta_AA * S_A * I_A + beta_AF * S_A * I_F + beta_AP * S_A * I_P)/(k_A + B_A) - v_A * I_A
  dIFdt <- (beta_Fl * S_F * l + beta_FA * S_F * I_A + beta_FF * S_F * I_F + beta_FP * S_F * I_P)/(k_F + B_F) - v_F * I_F
  dIPdt <- (beta_Pl * S_P * l + beta_PA * S_P * I_A + beta_PF * S_P * I_F + beta_PP * S_P * I_P)/(k_P + B_P) - v_P * I_P
  dldt <- -h * l
  
  # model with linear transmission
  # dLogSAdt <- r_A * (1 - alpha_AA * B_A - alpha_AF * B_F - alpha_AP * B_P) - (beta_Al * l + beta_AA * I_A + beta_AF * I_F + beta_AP * I_P)
  # dLogSFdt <- r_F * (1 - alpha_FA * B_A - alpha_FF * B_F - alpha_FP * B_P) - (beta_Fl * l + beta_FA * I_A + beta_FF * I_F + beta_FP * I_P)
  # dLogSPdt <- r_P * (1 - alpha_PA * B_A - alpha_PF * B_F - alpha_PP * B_P) - (beta_Pl * l + beta_PA * I_A + beta_PF * I_F + beta_PP * I_P)
  # dIAdt <- (beta_Al * exp(LogS_A) * l + beta_AA * exp(LogS_A) * I_A + beta_AF * exp(LogS_A) * I_F + beta_AP * exp(LogS_A) * I_P) - v_A * I_A
  # dIFdt <- (beta_Fl * exp(LogS_F) * l + beta_FA * exp(LogS_F) * I_A + beta_FF * exp(LogS_F) * I_F + beta_FP * exp(LogS_F) * I_P) - v_F * I_F
  # dIPdt <- (beta_Pl * exp(LogS_P) * l + beta_PA * exp(LogS_P) * I_A + beta_PF * exp(LogS_P) * I_F + beta_PP * exp(LogS_P) * I_P) - v_P * I_P
  # dldt <- -h * l

  # combine values
  dxdt <- c(dLogBAdt, dLogBFdt, dLogBPdt, dIAdt, dIFdt, dIPdt, dldt)
  
  # output
  list(dxdt)
}
```
We simulate the dynamics of each plant group alone and then all together over 160 days. Populations are initiated with 3000 plants and 4 grams of inoculum. We also simulated multiple starting values for plant density and litter inoculum and a range of virulence values.


### Annual alone
```{r A-only-continuous, echo = F}

# input values
times <- seq(0, 160, by = 1)
xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 3000),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0,
            l = 4)

# apply function
out <- ode(y = xstart, times = times, func = cont_mod_fun, parms = parms) %>%
  as.data.frame()

# modify data table
outA <- out %>%
  as_tibble() %>%
  mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
  select(-c(LogB_A, LogB_F, LogB_P)) %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop") %>%
  mutate(plant = case_when(is.na(plant) ~ "litter",
                             TRUE ~ plant),
         state = case_when(is.na(state) ~ "I",
                           TRUE ~ state))

# create figure
outA %>%
  filter(plant == "litter") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Litter (g)', title = "Litter (same for all simulations)")

outA %>%
  filter(plant != "litter") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')

# multiple starting values
starts <- seq(1, 5001, by = 500)

# empty list
outLA <- vector(mode = "list", length = length(starts))

# cycle through starting values
for(i in 1:length(starts)){

  xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * starts[i]),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0,
            l = as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 100)

  # apply function
  out <- ode(func = cont_mod_fun, y = xstart, times = times, parms = parms) %>%
    as.data.frame()

  # modify data table
  outLA[[i]] <- out %>%
    as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    pivot_longer(cols = -time,
                 names_to = c("state", "plant"),
                 names_pattern = "(.)_(.)",
                 values_to = "pop") %>%
    mutate(plant = case_when(is.na(plant) ~ "litter",
                             TRUE ~ plant),
           state = case_when(is.na(state) ~ "I",
                            TRUE ~ state),
           starting = starts[i])
}

# collapse list
outLA2 <- outLA %>%
  bind_rows() %>%
  filter(time == max(times))

# figure
outLA2 %>%
  filter(plant != "litter") %>%
  ggplot(aes(x = starting, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Initial population size', y='End of season biomass (g)')

# multiple litter starting values
starts <- seq(1, 1000, by = 50)

# empty list
outLL <- vector(mode = "list", length = length(starts))

# cycle through starting values
for(i in 1:length(starts)){

  xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 5000),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0,
            l = as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * starts[i])

  # apply function
  out <- ode(func = cont_mod_fun, y = xstart, times = times, parms = parms) %>%
    as.data.frame()

  # modify data table
  outLL[[i]] <- out %>%
    as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    pivot_longer(cols = -time,
                 names_to = c("state", "plant"),
                 names_pattern = "(.)_(.)",
                 values_to = "pop") %>%
    mutate(plant = case_when(is.na(plant) ~ "litter",
                             TRUE ~ plant),
           state = case_when(is.na(state) ~ "I",
                            TRUE ~ state),
           starting = starts[i])
}

# collapse list
outLL2 <- outLL %>%
  bind_rows() %>%
  filter(time == max(times))

# figure
outLL2 %>%
  filter(plant != "litter") %>%
  ggplot(aes(x = starting, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Initial litter inoculum', y='End of season biomass (g)')

# multiple virulence values
vir <- seq(0, 0.04, length.out = 10)
vir[1] <- 1e-20

# empty list
outLV <- vector(mode = "list", length = length(vir))

# cycle through starting values
for(i in 1:length(vir)){

  xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 3000),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0,
            l = 4)
  
  # set virulence value
  parms_in <- parms %>%
    mutate(Estimate = case_when(Parameter == "v_A" ~ vir[i],
                                TRUE ~ Estimate))

  # apply function
  out <- ode(func = cont_mod_fun, y = xstart, times = times, parms = parms_in) %>%
    as.data.frame()

  # modify data table
  outLV[[i]] <- out %>%
    as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    pivot_longer(cols = -time,
                 names_to = c("state", "plant"),
                 names_pattern = "(.)_(.)",
                 values_to = "pop") %>%
    mutate(plant = case_when(is.na(plant) ~ "litter",
                             TRUE ~ plant),
           state = case_when(is.na(state) ~ "I",
                            TRUE ~ state),
           virulence = vir[i])
}

# collapse list
outLV2 <- outLV %>%
  bind_rows() %>%
  filter(time == max(times))

# figure
outLV2 %>%
  filter(plant != "litter") %>%
  ggplot(aes(x = virulence, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Annual virulence', y='End of season biomass (g)')

```

### Perennial seedling alone
```{r F-only-continuous, echo = F}

# input values
times <- seq(0, 160)
xstart <- c(LogB_A = log(1e-10), 
            LogB_F = log(as.numeric(parms[parms$Parameter == "b_F", "Estimate"]) * 5000),
            LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0,
            l = as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 100)

# apply function
ode(
  func = cont_mod_fun,
  y = xstart,
  times = times,
  parms = parms
) %>%
  as.data.frame() -> out

# modify data table
outF <- out %>%
  as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop") %>%
  mutate(plant = case_when(is.na(plant) ~ "litter",
                             TRUE ~ plant),
         state = case_when(is.na(state) ~ "I",
                           TRUE ~ state))

# create figure
outF %>%
  filter(plant == "F") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')
```

### Perennial adult alone
```{r P-only-continuous, echo = F}

# input values
times <- seq(0, 160)
xstart <- c(LogB_A = log(1e-10), 
            LogB_F = log(1e-10),
            LogB_P = log(as.numeric(parms[parms$Parameter == "b_P", "Estimate"]) * 5000), 
            I_A = 0, I_F = 0, I_P = 0,
            l = as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 100)

# apply function
ode(
  func = cont_mod_fun,
  y = xstart,
  times = times,
  parms = parms
) %>%
  as.data.frame() -> out

# modify data table
outP <- out %>%
  as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop") %>%
  mutate(plant = case_when(is.na(plant) ~ "litter",
                             TRUE ~ plant),
         state = case_when(is.na(state) ~ "I",
                           TRUE ~ state))

# create figure
outP %>%
  filter(plant == "P") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')
```

### All species
```{r all-continuous, echo = F}

# input values
times <- seq(0, 160)
xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 5000),
            LogB_F = log(as.numeric(parms[parms$Parameter == "b_F", "Estimate"]) * 5000),
            LogB_P = log(as.numeric(parms[parms$Parameter == "b_P", "Estimate"]) * 5000),
            I_A = 0, I_F = 0, I_P = 0,
            l = as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 100)

# apply function
ode(
  func = cont_mod_fun,
  y = xstart,
  times = times,
  parms = parms
) %>%
  as.data.frame() -> out

# modify data table
outT <- out %>%
  as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop") %>%
  mutate(plant = case_when(is.na(plant) ~ "litter",
                             TRUE ~ plant),
         state = case_when(is.na(state) ~ "I",
                           TRUE ~ state))

# create figure
outT %>%
  filter(plant != "litter") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line(size = 2) +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')
```

## Discrete time model
```{r discrete-model, echo = F}
disc_mod_fun = function(AS0, AI0, F0, P0, L0, IA0, simtime, gs_days, disc_parms, con_parms){
  
  # initialize populations
  A_S <- rep(NA,simtime)
  A_I <- rep(NA,simtime)
  F1 <- rep(NA,simtime)
  P <- rep(NA,simtime)
  L <- rep(NA,simtime)
  B_A <- rep(NA,simtime)
  B_F <- rep(NA,simtime)
  B_P <- rep(NA,simtime)
  S_A <- rep(NA,simtime)
  S_F <- rep(NA,simtime)
  S_P <- rep(NA,simtime)
  I_A <- rep(NA,simtime)
  I_F <- rep(NA,simtime)
  I_P <- rep(NA,simtime)
  I_A0 <- rep(NA,simtime)
  
  A_S[1] <- AS0
  A_I[1] <- AI0
  F1[1] <- F0
  P[1] <- P0
  L[1] <- L0
  I_A0[1] <- IA0
  
  # parameters
  parms <- disc_parms
  
  s_A <- as.numeric(parms[parms$Parameter == "s_A", "Estimate"])
  g_S <- as.numeric(parms[parms$Parameter == "g_S", "Estimate"])
  g_I <- as.numeric(parms[parms$Parameter == "g_I", "Estimate"])
  p0 <- as.numeric(parms[parms$Parameter == "p0", "Estimate"])
  p1 <- as.numeric(parms[parms$Parameter == "p1", "Estimate"])
  c_A <- as.numeric(parms[parms$Parameter == "c_A", "Estimate"])
  b_A <- as.numeric(parms[parms$Parameter == "b_A", "Estimate"])
  e_A <- as.numeric(parms[parms$Parameter == "e_A", "Estimate"])
  gamma_A <- as.numeric(parms[parms$Parameter == "gamma_A", "Estimate"])
  
  s_P <- as.numeric(parms[parms$Parameter == "s_P", "Estimate"])
  g_P <- as.numeric(parms[parms$Parameter == "g_P", "Estimate"])
  c_F <- as.numeric(parms[parms$Parameter == "c_F", "Estimate"])
  c_P <- as.numeric(parms[parms$Parameter == "c_P", "Estimate"])
  b_F <- as.numeric(parms[parms$Parameter == "b_F", "Estimate"])
  e_P <- as.numeric(parms[parms$Parameter == "e_P", "Estimate"])
  gamma_P <- as.numeric(parms[parms$Parameter == "gamma_P", "Estimate"])
  
  l_P <- as.numeric(parms[parms$Parameter == "l_P", "Estimate"])
  w_F <- as.numeric(parms[parms$Parameter == "w_F", "Estimate"])
  b_P <- as.numeric(parms[parms$Parameter == "b_P", "Estimate"])
  
  d <- as.numeric(parms[parms$Parameter == "d", "Estimate"])
  
  grow_days <- seq(0, gs_days)
  
  # simulate population dynamics
  for(t in 1:(simtime - 1)){	
    
    # seedling establishment
    E_A <- e_A/(1 + gamma_A * L[t])
    E_P <- e_P/(1 + gamma_P * L[t])
    
    # biomass at the end of the growing season
    out <- ode(func = cont_mod_fun,
               y = c(LogB_A = log(g_S * E_A * b_A * A_S[t] + g_I * E_A * b_A * A_I[t]),
                     LogB_F = log(g_P * E_P * b_F * F1[t]),
                     LogB_P = log(b_P * P[t]),
                     I_A = 0, I_F = 0, I_P = 0,
                     l = I_A0[t]),
               times = grow_days,
               parms = con_parms) %>%
      as.data.frame()
    
    # modify output
    out2 <- out %>%
      as_tibble() %>%
      filter(time == gs_days) %>%
      mutate(B_A = exp(LogB_A),
             B_F = exp(LogB_F),
             B_P = exp(LogB_P),
             S_A = B_A - I_A,
             S_F = B_F - I_F,
             S_P = B_P - I_P) %>%
      select(-c(LogB_A, LogB_F, LogB_P))
    
    # save biomass
    B_A[t] <- as.numeric(out2$B_A)
    B_F[t] <- as.numeric(out2$B_F)
    B_P[t] <- as.numeric(out2$B_P)
    
    S_A[t] <- as.numeric(out2$S_A)
    S_F[t] <- as.numeric(out2$S_F)
    S_P[t] <- as.numeric(out2$S_P)
    
    I_A[t] <- as.numeric(out2$I_A)
    I_F[t] <- as.numeric(out2$I_F)
    I_P[t] <- as.numeric(out2$I_P)
    
    # inoculum for next year
    I_A0[t+1] <- I_A[t]
    
    # proportion seeds infected
    p <- ifelse(B_A[t] > 0, exp(p0 + p1 * I_A[t]/B_A[t])/(1 + exp(p0 + p1 * I_A[t]/B_A[t])), 0)
    
    # population size
    A_S[t+1] = s_A * (1 - g_S) * A_S[t] +  B_A[t] * c_A * (1-p)
    A_I[t+1] = B_A[t] * c_A * p
    L[t+1] = (1 - d) * L[t] + B_A[t]   
    F1[t+1] = s_P * (1 - g_P) * F1[t] + c_F * B_F[t] + c_P * B_P[t]
    P[t+1] = l_P * P[t] + g_P * E_P * w_F * F1[t]
    
    # correct to prevent negative numbers
    A_S[t+1] = ifelse(A_S[t+1] < 0, 0, A_S[t+1])
    A_I[t+1] = ifelse(A_I[t+1] < 0, 0, A_I[t+1])
    L[t+1] = ifelse(L[t+1] < 0, 0, L[t+1])
    F1[t+1] = ifelse(F1[t+1] < 0, 0, F1[t+1])
    P[t+1] = ifelse(P[t+1] < 0, 0, P[t+1])
    
  } 
  
  # last growing season
  # seedling establishment
    E_A <- e_A/(1 + gamma_A * L[simtime])
    E_P <- e_P/(1 + gamma_P * L[simtime])
    
    # biomass at the end of the growing season
    out3 <- ode(func = cont_mod_fun,
               y = c(LogB_A = log(g_S * E_A * b_A * A_S[simtime] + g_I * E_A * b_A * A_I[simtime]),
                     LogB_F = log(g_P * E_P * b_F * F1[simtime]),
                     LogB_P = log(b_P * P[simtime]),
                     I_A = 0, I_F = 0, I_P = 0,
                     l = I_A0[simtime]),
               times = grow_days,
               parms = con_parms) %>%
      as.data.frame()
    
    # modify output
    out4 <- out3 %>%
      as_tibble() %>%
      filter(time == gs_days) %>%
      mutate(B_A = exp(LogB_A),
             B_F = exp(LogB_F),
             B_P = exp(LogB_P),
             S_A = B_A - I_A,
             S_F = B_F - I_F,
             S_P = B_P - I_P) %>%
      select(-c(LogB_A, LogB_F, LogB_P))
    
    # save biomass
    B_A[simtime] <- as.numeric(out4$B_A)
    B_F[simtime] <- as.numeric(out4$B_F)
    B_P[simtime] <- as.numeric(out4$B_P)
    
    S_A[simtime] <- as.numeric(out4$S_A)
    S_F[simtime] <- as.numeric(out4$S_F)
    S_P[simtime] <- as.numeric(out4$S_P)
    
    I_A[simtime] <- as.numeric(out4$I_A)
    I_F[simtime] <- as.numeric(out4$I_F)
    I_P[simtime] <- as.numeric(out4$I_P)
    
  # total annual density
  A_T <- A_S + A_I
  
  # population data
  dfN <- tibble(time = rep(1:simtime, 15),
                species = rep(c("Susceptible annual",
                                "Infected annual",
                                "Annual",
                                "Perennial first-year", 
                                "Perennial adult", 
                                "Litter",
                                "Annual biomass",
                                "Perennial first-year biomass",
                                "Perennial adult biomass",
                                "Annual susceptible biomass",
                                "Perennial first-year susceptible biomass",
                                "Perennial adult susceptible biomass",
                                "Annual infected biomass",
                                "Perennial first-year infected biomass",
                                "Perennial adult infected biomass"), 
                              each = simtime),
                N = c(A_S, A_I, A_T, F1, P, L, B_A, B_F, B_P, S_A, S_F, S_P, I_A, I_F, I_P))

  # return
  return(dfN)
}
```

### Annual alone
```{r A-only-discrete, echo = F}

# input values
modA <- disc_mod_fun(AS0 = 100, AI0 = 0, F0 = 1e-10, P0 = 1e-10, L0 = 0, IA0 = 1, simtime = 10, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modA %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modA %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modA %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```


### Perennial first-year alone
```{r F-only-discrete, echo = F}

# input values
modF <- disc_mod_fun(AS0 = 1e-100, AI0 = 0, F0 = 100, P0 = 1e-10, L0 = 0, IA0 = 1, simtime = 100, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modF %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modF %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modF %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```

### Perennial adult alone
```{r P-only-discrete, echo = F}

# input values
modP <- disc_mod_fun(AS0 = 1e-100, AI0 = 0, F0 = 1e-10, P0 = 100, L0 = 0, IA0 = 1, simtime = 100, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modP %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modP %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modP %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```

### All species
```{r all-discrete, echo = F}

# input values
modT <- disc_mod_fun(AS0 = 10, AI0 = 0, F0 = 10, P0 = 10, L0 = 0, IA0 = 1, simtime = 100, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modT %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modT %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modT %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```


# Long-term simulation

To simulate historical and future dynamics, we start with a community consisting of only the perennial species. The annual species invades after 100 years, but there are is no disease (i.e., $\beta_{Al} = \beta_{Fl} = \beta_{Pl} = 0$, which prevents initial infection, and $p = 0$). After 100 more years, the annual begins to spread disease within the community (i.e., $\beta_{Al} = \beta_{Fl} = \beta_{Pl} = 0.001$). We begin with 10 first-year perennials and later introduce 10 annuals. We introduce disease by infecting 1/10th of the annual biomass from the previous year.

```{r long-term simulation, echo = F}

# # disease-free parms
# parms_df <- parms %>%
#   mutate(Estimate = case_when(Parameter %in% c("beta_Al", "beta_Fl", "beta_Pl", "p1") ~ 0,
#                               Parameter == "p0" ~ -100,
#                               TRUE ~ Estimate))
# 
# # perennial only
# modL1 <- disc_mod_fun(AS0 = 1e-100, AI0 = 0, F0 = 10, P0 = 1e-100, L0 = 0, IA0 = 0, simtime = 100, gs_days = 160, 
#                       disc_parms = parms_df, con_parms = parms_df)
# 
# # input values for next simulation
# modL2_in <- modL1 %>%
#   filter(time == max(time) &
#            species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult", "Litter", "Annual infected biomass")) %>%
#   select(-time) %>%
#   pivot_wider(names_from = species,
#               values_from = N) %>%
#   rename(AS0 = "Susceptible annual",
#          AI0 = "Infected annual",
#          F0 = "Perennial first-year",
#          P0 = "Perennial adult",
#          L0 = "Litter",
#          IA0 = "Annual infected biomass")
# 
# # annual invades without disease
# modL2 <- disc_mod_fun(AS0 = 10,
#                       AI0 = 0,
#                       F0 = modL2_in$F0,
#                       P0 = modL2_in$P0,
#                       L0 = 0,
#                       IA0 = 0,
#                       simtime = 100, gs_days = 160, disc_parms = parms_df, con_parms = parms_df)
# 
# # input values for next simulation
# modL3_in <- modL2 %>%
#   filter(time == max(time) &
#            species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult", "Litter", "Annual biomass")) %>%
#   select(-time) %>%
#   pivot_wider(names_from = species,
#               values_from = N) %>%
#   rename(AS0 = "Susceptible annual",
#          AI0 = "Infected annual",
#          F0 = "Perennial first-year",
#          P0 = "Perennial adult",
#          L0 = "Litter",
#          BA = "Annual biomass")
# 
# # disease appears
# modL3 <- disc_mod_fun(AS0 = modL3_in$AS0,
#                       AI0 = modL3_in$AI0,
#                       F0 = modL3_in$F0,
#                       P0 = modL3_in$P0,
#                       L0 = modL3_in$L0,
#                       IA0 = modL3_in$BA/10,
#                       simtime = 100, gs_days = 160, disc_parms = parms, con_parms = parms)
# 
# # combine
# modL <- modL1 %>%
#   full_join(modL2 %>%
#               mutate(time = time + 100)) %>%
#   full_join(modL3 %>%
#               mutate(time = time + 200))

# import data
modL <- read_csv("../output/discrete_continuous_model_time_series.csv")

# create figure
modL %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modL %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line(size = 2) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modL %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

# # save dataset
# write_csv(modL, "../output/discrete_continuous_model_time_series.csv")
```
# Virulence simulation
```{r virulence simulation}

# # virulence values
# vir <- seq(0, 0.03, length.out = 100)
# vir[1] <- 1e-20 # make first value non-zero
# 
# # empty list
# outV <- vector(mode = "list", length = length(vir))
# 
# # cycle through virulence
# for(i in 1:length(vir)){
#   
#   # set virulence value
#   parms_in <- parms %>%
#     mutate(Estimate = case_when(Parameter == "v_A" ~ vir[i],
#                                 TRUE ~ Estimate))
#   # simulation
#   modV <- disc_mod_fun(AS0 = modL3_in$AS0,
#                        AI0 = modL3_in$AI0,
#                        F0 = modL3_in$F0,
#                        P0 = modL3_in$P0,
#                        L0 = modL3_in$L0,
#                        IA0 = modL3_in$BA/10,
#                        simtime = 100, gs_days = 160, disc_parms = parms_in, con_parms = parms_in)
#                       
#   # save data table
#   outV[[i]] <- modV %>%
#     mutate(virulence = vir[i])
#   }
# 
# # collapse list
# outV2 <- outV %>%
#   bind_rows() %>%
#   filter(time == max(time))
# 
# import data
outV2 <- read_csv("../output/discrete_continous_model_virulence_simulation.csv")

# figure
filter(outV2, species %in% c("Susceptible annual", "Infected annual", "Annual", "Perennial first-year", "Perennial adult") & !is.na(N)) %>%
  ggplot(aes(x = virulence, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Annual virulence', y='Number of plants')

filter(outV2, species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") & !is.na(N)) %>%
  ggplot(aes(x = virulence, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Annual virulence', y='Biomass (g)')
# 
# # save dataset
# write_csv(outV2, "../output/discrete_continous_model_virulence_simulation.csv")

```
# Virulence/transmission simulation
```{r virulence transmission simulation}

# virulence and transmission values
# valsVB <- tibble(vir = c(1e-20, 0.00667, 0.00667*2, 0.00667*3)) %>%
#   expand_grid(tibble(beta = c(0.038, 0.038*2, 0.038*3)))
# 
# # empty list
# outVB <- vector(mode = "list", length = nrow(valsVB))
# 
# # cycle through virulence
# for(i in 1:nrow(valsVB)){
# 
#   # set virulence value
#   parms_in <- parms %>%
#     mutate(Estimate = case_when(Parameter == "v_A" ~ valsVB$vir[i],
#                                 Parameter == "beta_AA" ~ valsVB$beta[i],
#                                 TRUE ~ Estimate))
#   # simulation
#   modVB <- disc_mod_fun(AS0 = modL3_in$AS0,
#                        AI0 = modL3_in$AI0,
#                        F0 = modL3_in$F0,
#                        P0 = modL3_in$P0,
#                        L0 = modL3_in$L0,
#                        IA0 = modL3_in$BA/10,
#                        simtime = 100, gs_days = 160, disc_parms = parms_in, con_parms = parms_in)
# 
#   # save data table
#   outVB[[i]] <- modVB %>%
#     mutate(virulence = valsVB$vir[i],
#            transmission = valsVB$beta[i])
#   }
# 
# # collapse list
# outVB2 <- outVB %>%
#   bind_rows()

# import data
outVB2 <- read_csv("../output/discrete_continous_model_virulence_transmission_simulation.csv")

# figure
filter(outVB2, species %in% c("Annual", "Perennial first-year", "Perennial adult") & !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = as.factor(round(virulence, 3)), linetype = as.factor(transmission))) +
  geom_line() +
  facet_wrap(~ species) +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

filter(outVB2, species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
  ggplot(aes(x = time, y = N, color = as.factor(round(virulence, 3)), linetype = as.factor(transmission))) +
  geom_line() +
  facet_wrap(~ species) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

# # save dataset
# write_csv(outVB2, "../output/discrete_continous_model_virulence_transmission_simulation.csv")

```

# Figure
```{r figure}

# figure settings
fig_theme <- theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size = 8, color = "black"),
        axis.text.x = element_text(size = 8, color = "black"),
        axis.title.y = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.background = element_blank(),
        legend.key = element_rect(fill = NA),
        legend.position = "none",
        legend.margin = margin(-0.1, 0, 0.2, 2, unit = "cm"),
        plot.title = element_text(size = 8, hjust = 0.2),
        strip.text = element_text(size = 8, hjust = 0.2),
        strip.background = element_blank())

linePal = c("solid", "dashed", "solid")

# edit data
# timeDensDat <- modL %>%
#   filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev"))
# 
# timeBioDat <- modL %>%
#   filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev")) %>%
#   group_by(time) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)
# 
# virDensDat <- outV2 %>%
#   filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev"))
# 
# virBioDat <- outV2 %>%
#   filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev")) %>%
#   group_by(virulence) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)
# 
# timeVirDat <- outV %>%
#   bind_rows() %>%
#   filter(virulence == virBioDat %>%
#            filter(species == "Annual biomass") %>%
#            filter(N == min(N)) %>%
#            pull(virulence)) %>%
#   mutate(time = time + 200)
# 
# timeVirBioDat <- timeVirDat %>%
#   full_join(modL %>%
#               filter(time < 200)) %>%
#   filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev")) %>%
#   group_by(time) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)
# 
# timeVirDensDat <- timeVirDat %>%
#     full_join(modL %>%
#               filter(time < 200)) %>%
#   filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev")) 
# 
# virTransDensDat <- outVB2 %>%
#   filter(time >= (max(time) - 50) & species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   group_by(species, virulence, transmission) %>%
#   summarise(N = mean(N)) %>%
#   ungroup() %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev"),
#          virulence_abb = round(virulence, 3),
#          transmission_abb = round(transmission, 3),
#          virulenceF = case_when(virulence_abb == 0.000 ~ "observed",
#                                 virulence_abb == 0.007 ~ "previous studies",
#                                 virulence_abb == 0.013 ~ "2x previous",
#                                 virulence_abb == 0.020 ~ "3x previous") %>%
#            fct_relevel("observed", "previous studies"),
#          transmissionF = case_when(transmission_abb == 0.038 ~ "observed Mv transmission",
#                                    transmission_abb == 0.076 ~ "2x obs. Mv transmission",
#                                    transmission_abb == 0.114 ~ "3x obs. Mv transmission") %>%
#            fct_relevel("observed Mv transmission")) 
# 
# virTransBioDat <- outVB2 %>%
#   filter(time >= (max(time) - 50) & species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   group_by(species, virulence, transmission) %>%
#   summarise(N = mean(N)) %>%
#   ungroup() %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev"),
#          virulence_abb = round(virulence, 3),
#          transmission_abb = round(transmission, 3),
#          virulenceF = case_when(virulence_abb == 0.000 ~ "observed",
#                                 virulence_abb == 0.007 ~ "previous studies",
#                                 virulence_abb == 0.013 ~ "2x previous",
#                                 virulence_abb == 0.020 ~ "3x previous") %>%
#            fct_relevel("observed", "previous studies"),
#          transmissionF = case_when(transmission_abb == 0.038 ~ "observed Mv transmission",
#                                    transmission_abb == 0.076 ~ "2x obs. Mv transmission",
#                                    transmission_abb == 0.114 ~ "3x obs. Mv transmission") %>%
#            fct_relevel("observed Mv transmission")) %>%
#   group_by(transmissionF, virulenceF) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)

# virulence/transmission time series
outVB3 <- outVB2 %>%
  mutate(time = time + 200) %>%
  mutate(virulence_abb = round(virulence, 3),
         transmission_abb = round(transmission, 3),
         virulenceF = case_when(virulence_abb == 0.000 ~ "observed",
                                virulence_abb == 0.007 ~ "previous studies",
                                virulence_abb == 0.013 ~ "2x previous",
                                virulence_abb == 0.020 ~ "3x previous") %>%
           fct_relevel("observed", "previous studies"),
         transmissionF = case_when(transmission_abb == 0.038 ~ "observed Mv transmission",
                                   transmission_abb == 0.076 ~ "2x obs. Mv transmission",
                                   transmission_abb == 0.114 ~ "3x obs. Mv transmission") %>%
           fct_relevel("observed Mv transmission")) %>%
  filter((virulenceF == "observed" & transmissionF == "observed Mv transmission") |
           (virulenceF == "previous studies" & transmissionF == "observed Mv transmission") |
           (virulenceF == "3x previous" & transmissionF == "3x obs. Mv transmission")) %>%
  mutate(virTranF = case_when(virulenceF == "observed" ~ "Experiment\nvirulence & transmission",
                              virulenceF == "previous studies" ~ "Max observed\nvirulence & transmission",
                              virulenceF == "3x previous" ~ "3x max observed\nvirulence & transmission"),
         plant_type = case_when(species %in% c("Annual", "Perennial first-year", "Perennial adult") ~ "Density",
                                species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") ~ "Relative biomass")) %>%
  filter(!is.na(plant_type))

# calculate relative biomass
outVB4 <- outVB3 %>%
  filter(plant_type == "Relative biomass") %>%
  group_by(time, virTranF) %>%
  mutate(totBio = sum(N)) %>%
  ungroup() %>%
  mutate(N = N/totBio) %>%
  select(-totBio) %>%
  full_join(outVB3 %>%
              filter(plant_type == "Density"))

# format first 200 years
modVB4 <- modL %>%
  filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
  group_by(time) %>%
  mutate(totBio = sum(N)) %>%
  ungroup() %>%
  mutate(N = N/totBio,
         plant_type = "Relative biomass") %>%
  select(-totBio) %>%
  full_join(modL %>%
              filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
              mutate(plant_type = "Density"))

# combine with first 200 years
timeVirTransDat <- outVB4 %>%
  full_join(modVB4 %>%
              filter(time < 201) %>%
              expand_grid(outVB4 %>%
                            select(virTranF) %>%
                            unique())) %>%
  mutate(plant_group = case_when(species %in%  c("Annual", "Annual biomass") ~ "Mv",
                                 species %in%  c("Perennial first-year", "Perennial first-year biomass") ~ "first-\nyear Ev",
                                 species %in%  c("Perennial adult", "Perennial adult biomass") ~ "adult Ev"),
         virTranF =  fct_relevel(virTranF, "Experiment\nvirulence & transmission", "Max observed\nvirulence & transmission")) 

# text
timeVirTransText <- timeVirTransDat %>%
  filter(plant_type == "Density")  %>%
  filter(time %in% c(100, 200) & plant_group == "Mv") %>%
  mutate(label = case_when(time == 100 ~ "invasion\noccurs",
                           time == 200 ~ "disease\nemerges"),
         N = 3600)

# virulence/transmission time series
tiff("../output/discrete_continuous_model_time_series_virulence_transmission.tiff", width = 18, height = 11, units = "cm", res = 300)
ggplot(timeVirTransDat, aes(x = time, y = N)) +
  geom_rect(xmin = 100, xmax = 200, ymin = -Inf, ymax = Inf, fill = "gray95", color = NA, show.legend = F) +
  geom_rect(xmin = 200, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "gray75", color = NA, show.legend = F) +
  geom_line(aes(linetype = plant_group, color = plant_group), size = 0.8) +
  geom_text(data = timeVirTransText, aes(label = label), color = "black", size = 2.5, hjust = 0, vjust = 0.6, lineheight = 0.6) +
  facet_grid(plant_type ~ virTranF, scales = "free", switch = "y") +
  scale_color_viridis_d(name = "Plant group", end = 0.7, direction = -1) +
  scale_linetype_manual(name = "Plant group", values = linePal) +
  xlab("Time (years)") +
  fig_theme +
  theme(strip.placement = "outside",
        strip.text = element_text(size = 10, hjust = 0.5),
        axis.title.y = element_blank(),
        legend.position = c(-0.005, 0.85))
dev.off()

# # time series figures
# timeDensFig <- timeDensDat %>%
#   ggplot(aes(x = time, y = N, color = plant_group, linetype = plant_group)) +
#   geom_rect(xmin = 250, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "light gray", color = NA, show.legend = F) +
#   geom_line(size = 1.5) +
#   annotate("text", x = 100, y = 0, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0, label = "invasion occurs", hjust = 0, size = 2.5) +
#   annotate("text", x = 200, y = 3197, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 2900, label = "disease emerges", vjust = 1, size = 2.5) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = expression(paste('Density (', m^-2, ')', sep = "")), title = 'Observed Mv virulence and transmission') +
#   fig_theme +
#   theme(legend.position = c(0.04, 0.7))
# 
# tiff("../output/discrete_continuous_model_time_series_density_figure.tiff", width = 3, height = 3, units = "in", res = 300)
# timeDensFig +
#   theme(legend.position = "none")
# dev.off()
# 
# tiff("../output/discrete_continuous_model_time_series_legend_figure.tiff", width = 5, height = 5, units = "in", res = 300)
# timeDensFig +
#   scale_color_viridis_d(name = "Plant group:", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group:") +
#   theme(legend.position = "bottom",
#         legend.direction = "horizontal",
#         legend.key.width = unit(1.5, "cm"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title.y = element_blank())
# dev.off()
# 
# timeBioFig <- timeBioDat %>%
#   ggplot(aes(x = time, y = relBio, color = plant_group, linetype = plant_group)) +
#   geom_rect(xmin = 250, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "light gray", color = NA, show.legend = F) +
#   geom_line(size = 1.5) +
#   annotate("text", x = 100, y = 0.05, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0.05, label = "invasion occurs", hjust = 0, size = 2.5) +
#   annotate("text", x = 200, y = 0.882, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 0.8, label = "disease emerges", vjust = 1, size = 2.5) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = 'Proportional biomass', title = 'Observed Mv virulence and transmission') +
#   fig_theme
# 
# tiff("../output/discrete_continuous_model_time_series_rel_bio_figure.tiff", width = 3, height = 3, units = "in", res = 300)
# timeBioFig
# dev.off()
# 
# # virulence figures
# virDensFig <- virDensDat %>%
#   ggplot(aes(x = virulence, y = N, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = expression(paste('Mv virulence (', day^-1, ')', sep = "")), y = expression(paste('Final density (', m^-2, ')', sep = ""))) +
#   fig_theme
# 
# virBioFig <- virBioDat %>%
#   ggplot(aes(x = virulence, y = relBio, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = expression(paste('Mv virulence (', day^-1, ')', sep = "")), y = 'Final relative biomass') +
#   fig_theme
# 
# tiff("../output/discrete_continuous_model_time_series_virulence_figure.tiff", width = 7, height = 5, units = "in", res = 300)
# plot_grid(timeDensFig, timeBioFig, virDensFig, virBioFig,
#           nrow = 2,
#           labels = LETTERS[1:4])
# dev.off()
# 
# # high virulence time series figures
# timeVirDensFig <- timeVirDensDat %>%
#   ggplot(aes(x = time, y = N, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   annotate("text", x = 100, y = 0, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0, label = "invasion occurs", hjust = 0, size = 2) +
#   annotate("text", x = 200, y = 3197, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 2900, label = "disease emerges", vjust = 1, size = 2) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = expression(paste('Density (', m^-2, ')', sep = "")), title = "Virulence in previous studies") +
#   fig_theme
# 
# timeVirBioFig <- timeVirBioDat %>%
#   ggplot(aes(x = time, y = relBio, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   annotate("text", x = 100, y = 0.05, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0.05, label = "invasion occurs", hjust = 0, size = 2) +
#   annotate("text", x = 200, y = 0.882, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 0.8, label = "disease emerges", vjust = 1, size = 2) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = 'Relative biomass') +
#   fig_theme
# 
# tiff("../output/discrete_continuous_model_time_series_multi_panel_figure.tiff", width = 7, height = 5, units = "in", res = 300)
# plot_grid(timeDensFig + ggtitle("Virulence in this study"), timeBioFig, timeVirDensFig, timeVirBioFig,
#           nrow = 2,
#           labels = LETTERS[1:4])
# dev.off()
# 
# # virulence/transmission combinations
# tiff("../output/discrete_continuous_model_virulence_transmission_density_figure.tiff", width = 2, height = 3, units = "in", res = 300)
# ggplot(virTransDensDat, aes(x = virulenceF, y = N, fill = plant_group)) +
#   geom_bar(stat = "identity") +
#   facet_wrap(~ transmissionF, ncol = 1) +
#   scale_fill_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   labs(x = 'Mv virulence') +
#   scale_y_continuous(breaks = c(0, 1500, 3000)) +
#   fig_theme +
#   theme(axis.text.x = element_text(size = 8, color = "black", angle = 30, hjust = 1, vjust = 1),
#         axis.title.y = element_blank())
# dev.off()
# 
# tiff("../output/discrete_continuous_model_virulence_transmission_rel_bio_figure.tiff", width = 2, height = 3, units = "in", res = 300)
# ggplot(virTransBioDat, aes(x = virulenceF, y = relBio, fill = plant_group)) +
#   geom_bar(stat = "identity") +
#   facet_wrap(~ transmissionF, ncol = 1) +
#   scale_fill_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   labs(x = 'Mv virulence') +
#   scale_y_continuous(breaks = c(0, 0.5, 1)) +
#   fig_theme +
#   theme(axis.text.x = element_text(size = 8, color = "black", angle = 30, hjust = 1, vjust = 1),
#         axis.title.y = element_blank())
# dev.off()

# text values
timeDensDat %>% 
  filter(species %in% c("Perennial adult", "Perennial first-year") & time %in% c(100, 200)) %>%
  group_by(time) %>%
  summarise(N = sum(N))

timeBioDat %>% 
  filter(species %in% c("Perennial adult biomass", "Perennial first-year biomass") & time %in% c(100, 200, 300)) %>%
  group_by(time) %>%
  summarise(relBio = sum(relBio),
            bio = sum(N))

timeDensDat %>%
  filter(species == "Annual" & time %in% c(200, 300))

timeBioDat %>%
  filter(species == "Annual biomass" & time %in% c(200, 300))

virDensDat %>%
  filter(virulence == min(virulence) | N == min(N) | virulence == max(virulence))

virBioDat %>%
  filter(species %in% c("Perennial adult biomass", "Perennial first-year biomass")) %>%
  filter(round(virulence, 4) %in% c(0.0000, 0.0067)) %>%
  group_by(virulence) %>%
  summarise(relBio = sum(relBio),
            bio = sum(N))

virBioDat %>%
  filter(species == "Annual biomass") %>%
  filter(N == min(N)) %>%
  mutate(treatment = "control") %>%
  full_join(timeBioDat %>%
              filter(species == "Annual biomass" & time == 200) %>%
              mutate(treatment = "fungicide")) %>%
  select(treatment, N) %>%
  pivot_wider(names_from = treatment,
              values_from = N) %>%
  mutate(prop = (fungicide - control)/control)

virTransBioDat %>%
  filter(virulenceF == "3x previous" & transmissionF == "3x obs. Mv transmission" & plant_group != "Mv") %>%
  summarise(relBio = sum(relBio))
```

