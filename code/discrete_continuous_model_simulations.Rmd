---
title: "Model Simulations"
output: html_document
---

```{r setup, include=FALSE}
# to do:
# higher density dependence of Ev and Mv
# sensitivity analysis of model
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(tidyverse)
library(brms)
library(tidybayes)
library(kableExtra)
library(deSolve)
library(cowplot)
```

```{r parameters, include=FALSE}
#### growth ####

# load model
load("../output/focal_growth_biomass_model_2019_density_exp.rda")

# does fungicide significantly affect growth rates?
# note that these only apply when Mv is the background plant, although its density is 0
r_A_hyp = "fungicide = 0"
r_F_hyp = "fungicide + focs:fungicide = 0"
r_P_hyp = "fungicide + foca:fungicide = 0"

hypothesis(growthD2Mod2, c(r_A_hyp, r_F_hyp, r_P_hyp))
# yes, fungicide significantly lowers perennial adult growth rate
# use control values

# does fungicide significantly affect competition coefficients?
# assessed in focal_growth_2018_2019_density_exp.R
# yes, some competition coefficients for perennial adults are only significant with fungicide
# let's use control values with disease

# Stricker data (for alpha_AA)
# stricker <- read_csv("../intermediate-data/stricker_2016_extracted_figure.csv")
# max biomass is a fungicide treated plot

# growth rates and competition coefficients
growth_mod_parms <- posterior_samples(growthD2Mod2)  %>%
  rename_with(str_replace_all, pattern = ":", replacement = "_") %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(r_A = Intercept,
            r_F = Intercept + focs,
            r_P = Intercept + foca,
            alpha_AA = (plot_biomass + plot_biomass_fungicide),
            # alpha_AA = 1/max(stricker$biomass_g_m2),
            alpha_FA = (plot_biomass + plot_biomass_fungicide + plot_biomass_focs + plot_biomass_focs_fungicide),
            alpha_PA = (plot_biomass + plot_biomass_fungicide + plot_biomass_foca + plot_biomass_foca_fungicide),
            alpha_AF = (plot_biomass + plot_biomass_bgs + plot_biomass_fungicide + plot_biomass_bgs_fungicide),
            alpha_FF = (plot_biomass + plot_biomass_focs + plot_biomass_bgs + plot_biomass_focs_bgs + plot_biomass_fungicide + plot_biomass_focs_fungicide + plot_biomass_bgs_fungicide + plot_biomass_focs_bgs_fungicide),
            alpha_PF = (plot_biomass + plot_biomass_foca + plot_biomass_bgs + plot_biomass_foca_bgs + plot_biomass_fungicide + plot_biomass_foca_fungicide + plot_biomass_bgs_fungicide + plot_biomass_foca_bgs_fungicide),
            alpha_AP = (plot_biomass + plot_biomass_bga + plot_biomass_fungicide + plot_biomass_bga_fungicide),
            alpha_FP = (plot_biomass + plot_biomass_bga + plot_biomass_focs + plot_biomass_focs_bga + plot_biomass_fungicide + plot_biomass_bga_fungicide + plot_biomass_focs_fungicide + plot_biomass_focs_bga_fungicide),
            alpha_PP = (plot_biomass + plot_biomass_foca + plot_biomass_bga + plot_biomass_foca_bga + plot_biomass_fungicide + plot_biomass_foca_fungicide + plot_biomass_bga_fungicide + plot_biomass_foca_bga_fungicide),
            alpha_AA_dis = plot_biomass,
            alpha_FA_dis = (plot_biomass + plot_biomass_focs),
            alpha_PA_dis = (plot_biomass + plot_biomass_foca),
            alpha_AF_dis = (plot_biomass + plot_biomass_bgs),
            alpha_FF_dis = (plot_biomass + plot_biomass_focs + plot_biomass_bgs + plot_biomass_focs_bgs),
            alpha_PF_dis = (plot_biomass + plot_biomass_foca + plot_biomass_bgs + plot_biomass_foca_bgs),
            alpha_AP_dis = (plot_biomass + plot_biomass_bga),
            alpha_FP_dis = (plot_biomass + plot_biomass_bga + plot_biomass_focs + plot_biomass_focs_bga),
            alpha_PP_dis = (plot_biomass + plot_biomass_foca + plot_biomass_bga + plot_biomass_foca_bga)) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  mutate(estimate = case_when(substr(parameter, 1, 1) == "r" ~ estimate,
                              TRUE ~ estimate * -1)) %>% # scale all competition coefficients
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual-annual competition",
                            "annual-first-year perennial competition",
                            "annual-adult perennial competition",
                            "first-year perennial-annual competition",
                            "first-year perennial-first-year perennial competition",
                            "first-year perennial-adult perennial competition",
                            "adult perennial-annual competition",
                            "adult perennial-first-year perennial competition",
                            "adult perennial-adult perennial competition",
                            "annual-annual competition with disease",
                            "annual-first-year perennial competition with disease",
                            "annual-adult perennial competition with disease",
                            "first-year perennial-annual competition with disease",
                            "first-year perennial-first-year perennial competition with disease",
                            "first-year perennial-adult perennial competition with disease",
                            "adult perennial-annual competition with disease",
                            "adult perennial-first-year perennial competition with disease",
                            "adult perennial-adult perennial competition with disease",
                            "annual growth rate",
                            "perennial first-year growth rate",
                            "perennial adult growth rate"),
            Estimate = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ estimate/160, # r may not be sig, but we need an estimate
                                 .lower < 0 & .upper > 0 ~ 0,
                                 estimate < 0 ~ 0,
                                 TRUE ~ estimate),
            Lower = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ .lower/160,
                              #parameter == "alpha_AA" ~ NA_real_, # not estimated with replicates
                              .lower < 0 & .upper > 0 ~ NA_real_,
                              estimate < 0 ~ NA_real_,
                              TRUE ~ .lower),
            Upper = case_when(parameter %in% c("r_A", "r_F", "r_P") ~ .upper/160,
                              #parameter == "alpha_AA" ~ NA_real_,
                              .lower < 0 & .upper > 0 ~ NA_real_,
                              estimate < 0 ~ NA_real_,
                              TRUE ~ .upper),
            Units = c(rep("g^-1^", 18), rep("day^-1^", 3)),
            Source = "experiment")


#### transmission ####

# load model
load("../output/plot_transmission_model_2019_density_exp.rda")

# does fungicide significantly affect transmission rates?
# assessed in plot_severity_model_2018_2019_density_exp.R
# yes, some transmission to Ev seedlings are only significant with fungicide
# let's assume these could also apply with ctrl conditions

# transmission rates
trans_mod_parms <- posterior_samples(sevD2Mod)  %>%
  rename_with(str_replace_all, pattern = ":", replacement = "_") %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(beta_AA = bg_severity,
            beta_FA = bg_severity + bg_severity_fungicide + bg_severity_focs + bg_severity_focs_fungicide,
            beta_PA = bg_severity + bg_severity_foca,
            beta_AF = bg_severity + bg_severity_bgs,
            beta_FF = bg_severity + bg_severity_focs + bg_severity_bgs + bg_severity_focs_bgs,
            beta_PF = bg_severity + bg_severity_foca + bg_severity_bgs + bg_severity_foca_bgs,
            beta_AP = bg_severity + bg_severity_bga,
            beta_FP = bg_severity + bg_severity_bga + bg_severity_focs + bg_severity_focs_bga + bg_severity_fungicide + bg_severity_bga_fungicide + bg_severity_focs_fungicide + bg_severity_focs_bga_fungicide,
            beta_PP = bg_severity + bg_severity_foca + bg_severity_bga + bg_severity_foca_bga) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual-annual transmission",
                            "annual-first-year perennial transmission",
                            "annual-adult perennial transmission",
                            "first-year perennial-annual transmission",
                            "first-year perennial-first-year perennial transmission",
                            "first-year perennial-adult perennial transmission",
                            "adult perennial-annual transmission",
                            "adult perennial-first-year perennial transmission",
                            "adult perennial-adult perennial transmission"),
            Estimate = case_when(.lower < 0 & .upper > 0 ~ 0,
                                 TRUE ~ estimate/30), # days between censuses
            Lower = case_when(.lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .lower/30),
            Upper = case_when(.lower < 0 & .upper > 0 ~ NA_real_,
                              TRUE ~ .upper/30),
            Units = "day^-1^ g^-1^",
            Source = "experiment")


#### seed infection ####

load("../output/mv_seed_infection_dark_model_2018_density_exp.rda")

seed_inf_parms <- posterior_samples(mvPropDarkMod)  %>%
  transmute(p0 = b_Intercept,
            p1 = b_sep_severity) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("seed infection parameter",
                            "seed infection parameter"),
            Estimate = round(estimate, 3),
            Lower = round(.lower, 3),
            Upper = round(.upper, 3),
            Units = "NA",
            Source = "experiment")


#### germination ####

load("../output/mv_germination_infection_model_2018_density_exp.rda")

mv_germ_parms <- posterior_samples(mvGermD1Mod)  %>%
  transmute(g_S = exp(b_Intercept)/(1 +  exp(b_Intercept)),
            g_I = exp(b_Intercept + b_prop_dark)/(1 +  exp(b_Intercept + b_prop_dark))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("infected annual germination fraction",
                            "susceptible annual germination fraction"),
            Estimate = round(estimate, 3),
            Lower = round(.lower, 3),
            Upper = round(.upper, 3),
            Units = "NA",
            Source = "experiment")

load("../output/ev_germination_severity_model_2018_2019_density_exp.rda")

ev_germ_parms <- posterior_samples(evGermMod)  %>%
  transmute(g_P = exp(b_Intercept)/(1 +  exp(b_Intercept))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("perennial germination fraction"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### seeds per biomass ####

load("../output/mv_seeds_per_biomass_untransformed_model_2019_density_exp.rda")
load("../output/evS_seeds_per_biomass_untransformed_model_2019_density_exp.rda")
load("../output/evA_seeds_per_biomass_untransformed_model_2019_density_exp.rda")

mv_seed_parms <- posterior_samples(mvSeedsBioD2Mod2)  %>%
  transmute(c_A = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")

evS_seed_parms <- posterior_samples(evSSeedsBioD2Mod2)  %>%
  transmute(c_F = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("first-year perennial seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")

evA_seed_parms <- posterior_samples(evASeedsBioD2Mod2)  %>%
  transmute(c_P = b_biomass_weight.g) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("adult perennial seed conversion"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "seeds g^-1^",
            Source = "experiment")


#### establishment ####

load("../output/survival_severity_model_2018_density_exp.rda")

est_mod_parms <- posterior_samples(survSevD1Mod)  %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(e_A = exp(Intercept)/(1 + exp(Intercept)),
            e_P = exp(Intercept + focs)/(1 + exp(Intercept + focs))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = c("annual establishment fraction",
                            "perennial establishment fraction"),
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### adult survival ####

load("../output/ev_adult_survival_model_2018_2019_density_exp.rda")

evA_surv_parms <- posterior_samples(adultSurvD1Mod)  %>%
  transmute(l_P = exp(b_Intercept)/(1 + exp(b_Intercept))) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = "adult perennial survival fraction",
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "NA",
            Source = "experiment")


#### adult biomass survival ####

ev_fung_gh <- read_csv("../data/ev_biomass_dec_2019_fungicide_exp.csv")

evA_bio_surv_parms <- ev_fung_gh %>%
  select(-notes) %>%
  pivot_wider(names_from = biomass_type,
              values_from = weight.g) %>%
  mutate(prop_live = live / (dead + live)) %>%
  summarise(Estimate = mean(prop_live, na.rm = T) * evA_surv_parms$Estimate) %>%
  mutate(Parameter = "l_B",
         Description = "adult perennial surviving biomass",
         Lower = NA,
         Upper = NA,
         Units = "NA",
         Source = "experiment")


#### non-growing season survival ####

# load("../output/winter_survival_severity_model_2018_density_exp.rda")
# 
# ngs_surv_parms <- posterior_samples(winSurvSevD1Mod)  %>%
#   rename_with(str_replace, pattern = "b_", replacement = "") %>%
#   transmute(w = exp(Intercept + focs)/(1 + exp(Intercept + focs))) %>%
#   pivot_longer(cols = everything(),
#                names_to = "parameter",
#                values_to = "estimate") %>%
#   group_by(parameter) %>%
#   mean_hdi(estimate) %>%
#   transmute(Parameter = parameter,
#             Description = "first-year perennial non-growing season survival fraction",
#             Estimate = estimate,
#             Lower = .lower,
#             Upper = .upper,
#             Units = "NA",
#             Source = "experiment")


#### initial biomass ####

mvBioD2Dat <- read_csv("../data/mv_biomass_seeds_2019_density_exp.csv")
evBioD2Dat <- read_csv("../data/ev_biomass_seeds_oct_2019_density_exp.csv")

init_bio_parms <- tibble(Parameter = c("b_A", "b_F", "b_P"),
                         Description = c("annual initial biomass",
                                         "first-year perennial initial biomass",
                                         "adult perennial initial biomass"),
                         Estimate = c(min(mvBioD2Dat$biomass_weight.g, na.rm = T)/10,
                                      min(filter(evBioD2Dat, ID %in% c("1", "2", "3"))$weight, na.rm = T)/10,
                                      min(filter(evBioD2Dat, ID == "A")$weight, na.rm = T)/10),
                         Lower = rep(NA_real_, 3),
                         Upper = rep(NA_real_, 3),
                         Units = rep("g", 3),
                         Source = rep("experiment", 3))


#### litter sensitivity ####

load("../output/litter_reu_mv_establishment_model.rda")

mv_lit_parms <- posterior_samples(mv_bh_mod)  %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(gamma_A = beta_Intercept) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = "annual sensitivity to litter",
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "g^-1^",
            Source = "Benitez et al. 2021")

load("../output/litter_reu_ev_establishment_model.rda")

ev_lit_parms <- posterior_samples(ev_bh_mod)  %>%
  rename_with(str_replace, pattern = "b_", replacement = "") %>%
  transmute(gamma_P = beta_Intercept) %>%
  pivot_longer(cols = everything(),
               names_to = "parameter",
               values_to = "estimate") %>%
  group_by(parameter) %>%
  mean_hdi(estimate) %>%
  transmute(Parameter = parameter,
            Description = "annual sensitivity to litter",
            Estimate = estimate,
            Lower = .lower,
            Upper = .upper,
            Units = "g^-1^",
            Source = "Benitez et al. 2021")


#### literature/estimated parameters ####

lit_parms <- tibble(Parameter = c("beta_AC", "beta_FC", "beta_PC", 
                                  "k_A", "k_F", "k_P",
                                  "v_A", "v_F", "v_P", 
                                  "h", "b",
                                  "s_A", "s_P", 
                                  "d",
                                  "m_A", "m_F", "m_P"),
                    Description = c("litter transmission to annuals",
                                    "litter transmission to first-year perennials",
                                    "litter transmission to adult perennials",
                                    "transmission saturation constant for annuals",
                                    "transmission saturation constant for first-year perennials",
                                    "transmission saturation constant for adult perennials",
                                    "annual infected tissue loss",
                                    "perennial first-year infected tissue loss",
                                    "perennial adult infected tissue loss",
                                    "inoculum addition to litter",
                                    "inoculum loss from litter",
                                    "annual surviving seed fraction",
                                    "perennial surviving seed fraction",
                                    "annual litter decomposition fraction",
                                    "annual biomass mortality",
                                    "perennial first-year biomass mortality",
                                    "perennial adult biomass mortality"),
                     Estimate = c(rep(0.001, 3), rep(10, 3), rep(1e-20, 3), 5500, 0.9, 0.15, 0.05, 0.59, 0.0045, 0.0045, 0.0045),
                     Source = c(rep("NA", 9), "Benitez et al. 2020", "NA", "Redwood et al. 2018", "Garrison and Stier 2010", "DeMeester and Richter 2010", rep("NA", 3))) %>%
  mutate(Lower = NA_real_,
         Upper = NA_real_,
         Units = c(rep ("day^-1^ g^-1^", 3), rep ("g", 3), rep("day^-1^", 3), "g^-1^", "day^-1^", rep("NA", 2), "NA", rep("day^-1^", 3)))


#### combine ####
parms <- growth_mod_parms %>%
  full_join(trans_mod_parms) %>%
  full_join(seed_inf_parms) %>%
  full_join(mv_germ_parms) %>%
  full_join(ev_germ_parms) %>%
  full_join(mv_seed_parms) %>%
  full_join(evS_seed_parms) %>%
  full_join(evA_seed_parms) %>%
  full_join(est_mod_parms) %>%
  full_join(evA_surv_parms) %>%
  full_join(evA_bio_surv_parms) %>%
  # full_join(ngs_surv_parms) %>%
  full_join(init_bio_parms) %>%
  full_join(mv_lit_parms) %>%
  full_join(ev_lit_parms) %>%
  full_join(lit_parms)

write_csv(parms, "../output/discrete_continuous_model_parameters_2018_2019_density_exp.csv")
```

```{r parm-table, echo=FALSE, results='asis'}
kable(parms, digits = 3, align = c("l", "l", "c", "c", "c", "c", "c"))
```


# Simulations

## Continuous time model
```{r continuous-model, include=FALSE}
# continuous model
cont_mod_fun <- function(t, x, params) {
  
  # initial conditions
  LogB_A <- x[1]
  LogB_F <- x[2]
  LogB_P <- x[3]
  I_A <- x[4]
  I_F <- x[5]
  I_P <- x[6]
  D <- x[7]
  C <- x[8]

  # parameters
  r_A <- as.numeric(params[params$Parameter == "r_A", "Estimate"])
  r_F <- as.numeric(params[params$Parameter == "r_F", "Estimate"])
  r_P <- as.numeric(params[params$Parameter == "r_P", "Estimate"])

  alpha_AA <- as.numeric(params[params$Parameter == "alpha_AA", "Estimate"])
  alpha_AF <- as.numeric(params[params$Parameter == "alpha_AF", "Estimate"])
  alpha_AP <- as.numeric(params[params$Parameter == "alpha_AP", "Estimate"])
  alpha_FA <- as.numeric(params[params$Parameter == "alpha_FA", "Estimate"])
  alpha_FF <- as.numeric(params[params$Parameter == "alpha_FF", "Estimate"])
  alpha_FP <- as.numeric(params[params$Parameter == "alpha_FP", "Estimate"])
  alpha_PA <- as.numeric(params[params$Parameter == "alpha_PA", "Estimate"])
  alpha_PF <- as.numeric(params[params$Parameter == "alpha_PF", "Estimate"])
  alpha_PP <- as.numeric(params[params$Parameter == "alpha_PP", "Estimate"])

  beta_AC <- as.numeric(params[params$Parameter == "beta_AC", "Estimate"])
  beta_FC <- as.numeric(params[params$Parameter == "beta_FC", "Estimate"])
  beta_PC <- as.numeric(params[params$Parameter == "beta_PC", "Estimate"])
  beta_AA <- as.numeric(params[params$Parameter == "beta_AA", "Estimate"])
  beta_AF <- as.numeric(params[params$Parameter == "beta_AF", "Estimate"])
  beta_AP <- as.numeric(params[params$Parameter == "beta_AP", "Estimate"])
  beta_FA <- as.numeric(params[params$Parameter == "beta_FA", "Estimate"])
  beta_FF <- as.numeric(params[params$Parameter == "beta_FF", "Estimate"])
  beta_FP <- as.numeric(params[params$Parameter == "beta_FP", "Estimate"])
  beta_PA <- as.numeric(params[params$Parameter == "beta_PA", "Estimate"])
  beta_PF <- as.numeric(params[params$Parameter == "beta_PF", "Estimate"])
  beta_PP <- as.numeric(params[params$Parameter == "beta_PP", "Estimate"])

  k_A <- as.numeric(params[params$Parameter == "k_A", "Estimate"])
  k_F <- as.numeric(params[params$Parameter == "k_F", "Estimate"])
  k_P <- as.numeric(params[params$Parameter == "k_P", "Estimate"])

  v_A <- as.numeric(params[params$Parameter == "v_A", "Estimate"])
  v_F <- as.numeric(params[params$Parameter == "v_F", "Estimate"])
  v_P <- as.numeric(params[params$Parameter == "v_P", "Estimate"])
  
  m_A <- as.numeric(params[params$Parameter == "m_A", "Estimate"])
  m_F <- as.numeric(params[params$Parameter == "m_F", "Estimate"])
  m_P <- as.numeric(params[params$Parameter == "m_P", "Estimate"])

  h <- as.numeric(params[params$Parameter == "h", "Estimate"])
  b <- as.numeric(params[params$Parameter == "b", "Estimate"])
  
  # derived values
  B_A <- exp(LogB_A)
  B_F <- exp(LogB_F)
  B_P <- exp(LogB_P)
  S_A <- B_A - I_A
  S_F <- B_F - I_F
  S_P <- B_P - I_P
  
  # model with asymptotic transmission
  dLogBAdt <- r_A * (1 - alpha_AA * B_A - alpha_AF * B_F - alpha_AP * B_P) - m_A - v_A * I_A / B_A
  dLogBFdt <- r_F * (1 - alpha_FA * B_A - alpha_FF * B_F - alpha_FP * B_P) - m_F - v_F * I_F / B_F
  dLogBPdt <- r_P * (1 - alpha_PA * B_A - alpha_PF * B_F - alpha_PP * B_P) - m_P - v_P * I_P / B_P
  dIAdt <- (beta_AC * S_A * C + beta_AA * S_A * I_A + beta_AF * S_A * I_F + beta_AP * S_A * I_P)/(k_A + B_A) - (m_A + v_A) * I_A
  dIFdt <- (beta_FC * S_F * C + beta_FA * S_F * I_A + beta_FF * S_F * I_F + beta_FP * S_F * I_P)/(k_F + B_F) - (m_F + v_F) * I_F
  dIPdt <- (beta_PC * S_P * C + beta_PA * S_P * I_A + beta_PF * S_P * I_F + beta_PP * S_P * I_P)/(k_P + B_P) - (m_P + v_P) * I_P
  dDdt <- v_A * I_A
  dCdt <- h * D - b * C
  
  # model with linear transmission
  # dLogSAdt <- r_A * (1 - alpha_AA * B_A - alpha_AF * B_F - alpha_AP * B_P) - (beta_AC * C + beta_AA * I_A + beta_AF * I_F + beta_AP * I_P)
  # dLogSFdt <- r_F * (1 - alpha_FA * B_A - alpha_FF * B_F - alpha_FP * B_P) - (beta_FC * C + beta_FA * I_A + beta_FF * I_F + beta_FP * I_P)
  # dLogSPdt <- r_P * (1 - alpha_PA * B_A - alpha_PF * B_F - alpha_PP * B_P) - (beta_PC * C + beta_PA * I_A + beta_PF * I_F + beta_PP * I_P)
  # dIAdt <- (beta_AC * exp(LogS_A) * C + beta_AA * exp(LogS_A) * I_A + beta_AF * exp(LogS_A) * I_F + beta_AP * exp(LogS_A) * I_P) - v_A * I_A
  # dIFdt <- (beta_FC * exp(LogS_F) * C + beta_FA * exp(LogS_F) * I_A + beta_FF * exp(LogS_F) * I_F + beta_FP * exp(LogS_F) * I_P) - v_F * I_F
  # dIPdt <- (beta_PC * exp(LogS_P) * C + beta_PA * exp(LogS_P) * I_A + beta_PF * exp(LogS_P) * I_F + beta_PP * exp(LogS_P) * I_P) - v_P * I_P
  # dDdt <- v_A * I_A
  # dCdt <- m * D - h * C

  # combine values
  dxdt <- c(dLogBAdt, dLogBFdt, dLogBPdt, dIAdt, dIFdt, dIPdt, dDdt, dCdt)
  
  # output
  list(dxdt)
}
```
We simulate the dynamics of each plant group alone and then all together over 160 days. Populations are initiated with 10 plants and 1 gram of inoculum. We also simulated multiple starting values for plant density and litter inoculum and a range of virulence values.


### Annual alone
```{r A-only-continuous, echo = F}

# input values
times <- seq(0, 160, by = 1)
xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 10),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0, D = 0,
            C = as.numeric(parms[parms$Parameter == "h", "Estimate"]))

# apply function
out <- ode(y = xstart, times = times, func = cont_mod_fun, parms = parms) %>%
  as.data.frame()

# modify data table
outA <- out %>%
  as_tibble() %>%
  mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
  select(-c(LogB_A, LogB_F, LogB_P)) %>%
  rename("I_C" = "C", "I_D" = "D") %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop")

# create figure
outA %>%
  filter(plant %in% c("C", "D")) %>%
  ggplot(aes(x = time, y = pop)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~ plant, scales = "free_y") +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', title = "Conidia/Litter")

outA %>%
  filter(!(plant %in% c("C", "D"))) %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line() +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')

# multiple starting values
starts <- seq(1, 5001, by = 500)

# empty list
outLA <- vector(mode = "list", length = length(starts))

# cycle through starting values
for(i in 1:length(starts)){

  xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * starts[i]),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0, D = 0,
            C = as.numeric(parms[parms$Parameter == "h", "Estimate"]))

  # apply function
  out <- ode(func = cont_mod_fun, y = xstart, times = times, parms = parms) %>%
    as.data.frame()

  # modify data table
  outLA[[i]] <- out %>%
    as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
      rename("I_C" = "C", "I_D" = "D") %>%
    pivot_longer(cols = -time,
                 names_to = c("state", "plant"),
                 names_pattern = "(.)_(.)",
                 values_to = "pop") %>%
    mutate(starting = starts[i])
}

# collapse list
outLA2 <- outLA %>%
  bind_rows() %>%
  filter(time == max(times))

# figure
outLA2 %>%
  filter(plant != "C") %>%
  ggplot(aes(x = starting, y = pop, color = plant, linetype = state)) +
  geom_line() +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Initial population size', y='End of season biomass (g)')

# multiple conidia starting values
starts <- seq(1, 101, by = 10)

# empty list
outLL <- vector(mode = "list", length = length(starts))

# cycle through starting values
for(i in 1:length(starts)){

  xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 5000),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0, D = 0,
            C = as.numeric(parms[parms$Parameter == "h", "Estimate"]) * starts[i])

  # apply function
  out <- ode(func = cont_mod_fun, y = xstart, times = times, parms = parms) %>%
    as.data.frame()

  # modify data table
  outLL[[i]] <- out %>%
    as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    rename("I_C" = "C", "I_D" = "D") %>%
    pivot_longer(cols = -time,
                 names_to = c("state", "plant"),
                 names_pattern = "(.)_(.)",
                 values_to = "pop") %>%
    mutate(starting = starts[i])
}

# collapse list
outLL2 <- outLL %>%
  bind_rows() %>%
  filter(time == max(times))

# figure
outLL2 %>%
  filter(plant != "C") %>%
  ggplot(aes(x = starting, y = pop, color = plant, linetype = state)) +
  geom_line() +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Initial litter inoculum', y='End of season biomass (g)')

# multiple virulence values
vir <- seq(0, 0.04, length.out = 10)
vir[1] <- 1e-20

# empty list
outLV <- vector(mode = "list", length = length(vir))

# cycle through starting values
for(i in 1:length(vir)){

  xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 3000),
            LogB_F = log(1e-10), LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0, D = 0,
            C = as.numeric(parms[parms$Parameter == "h", "Estimate"]))

  # set virulence value
  parms_in <- parms %>%
    mutate(Estimate = case_when(Parameter == "v_A" ~ vir[i],
                                TRUE ~ Estimate))

  # apply function
  out <- ode(func = cont_mod_fun, y = xstart, times = times, parms = parms_in) %>%
    as.data.frame()

  # modify data table
  outLV[[i]] <- out %>%
    as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    rename("I_C" = "C", "I_D" = "D") %>%
    pivot_longer(cols = -time,
                 names_to = c("state", "plant"),
                 names_pattern = "(.)_(.)",
                 values_to = "pop") %>%
    mutate(virulence = vir[i])
}

# collapse list
outLV2 <- outLV %>%
  bind_rows() %>%
  filter(time == max(times))

# figure
outLV2 %>%
  filter(plant == "C") %>%
  ggplot(aes(x = virulence, y = pop, linetype = state)) +
  geom_line() +
  theme_classic() +
  labs(x='Annual virulence', y='End of season conidia')

outLV2 %>%
  filter(plant != "C") %>%
  ggplot(aes(x = virulence, y = pop, color = plant, linetype = state)) +
  geom_line() +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Annual virulence', y='End of season biomass (g)')

```

### Perennial seedling alone
```{r F-only-continuous, echo = F}

# input values
times <- seq(0, 160)
xstart <- c(LogB_A = log(1e-10), 
            LogB_F = log(as.numeric(parms[parms$Parameter == "b_F", "Estimate"]) * 10),
            LogB_P = log(1e-10), I_A = 0, I_F = 0, I_P = 0, D = 0,
            C = as.numeric(parms[parms$Parameter == "h", "Estimate"]))

# apply function
ode(
  func = cont_mod_fun,
  y = xstart,
  times = times,
  parms = parms
) %>%
  as.data.frame() -> out

# modify data table
outF <- out %>%
  as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    rename("I_C" = "C", "I_D" = "D") %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop")

# create figure
outF %>%
  filter(plant != "C") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line() +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')
```

### Perennial adult alone
```{r P-only-continuous, echo = F}

# input values
times <- seq(0, 160)
xstart <- c(LogB_A = log(1e-10), 
            LogB_F = log(1e-10),
            LogB_P = log(as.numeric(parms[parms$Parameter == "b_P", "Estimate"]) * 10), 
            I_A = 0, I_F = 0, I_P = 0, D = 0,
            C = as.numeric(parms[parms$Parameter == "h", "Estimate"]))

# apply function
ode(
  func = cont_mod_fun,
  y = xstart,
  times = times,
  parms = parms
) %>%
  as.data.frame() -> out

# modify data table
outP <- out %>%
  as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    rename("I_C" = "C", "I_D" = "D") %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop")

# create figure
outP %>%
  filter(plant != "C") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line() +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')
```

### All species
```{r all-continuous, echo = F}

# input values
times <- seq(0, 160)
xstart <- c(LogB_A = log(as.numeric(parms[parms$Parameter == "b_A", "Estimate"]) * 10),
            LogB_F = log(as.numeric(parms[parms$Parameter == "b_F", "Estimate"]) * 10),
            LogB_P = log(as.numeric(parms[parms$Parameter == "b_P", "Estimate"]) * 10),
            I_A = 0, I_F = 0, I_P = 0, D = 0,
            C = as.numeric(parms[parms$Parameter == "h", "Estimate"]))
            # C = 0)

# apply function
ode(
  func = cont_mod_fun,
  y = xstart,
  times = times,
  parms = parms
) %>%
  as.data.frame() -> out

# modify data table
outT <- out %>%
  as_tibble() %>%
    mutate(B_A = exp(LogB_A),
         B_F = exp(LogB_F),
         B_P = exp(LogB_P),
         S_A = B_A - I_A,
         S_F = B_F - I_F,
         S_P = B_P - I_P) %>%
    select(-c(LogB_A, LogB_F, LogB_P)) %>%
    rename("I_C" = "C", "I_D" = "D") %>%
  pivot_longer(cols = -time,
               names_to = c("state", "plant"),
               names_pattern = "(.)_(.)",
               values_to = "pop")

# create figure
outT %>%
  filter(plant != "C") %>%
  ggplot(aes(x = time, y = pop, color = plant, linetype = state)) +
  geom_line() +
  theme_classic() +
  theme(legend.key.width = unit(1.5, 'cm')) +
  labs(x='Time (days)', y='Biomass (g)')
```

## Discrete time model
```{r discrete-model, echo = F}
disc_mod_fun = function(AS0, AI0, F0, P0, L0, C0, IA0, BP0, BF0, simtime, gs_days, disc_parms, con_parms){
  
  # initialize populations
  A_S <- rep(NA,simtime)
  A_I <- rep(NA,simtime)
  F1 <- rep(NA,simtime)
  P <- rep(NA,simtime)
  L <- rep(NA,simtime)
  B_A <- rep(NA,simtime)
  B_F <- rep(NA,simtime)
  B_P <- rep(NA,simtime)
  S_A <- rep(NA,simtime)
  S_F <- rep(NA,simtime)
  S_P <- rep(NA,simtime)
  I_A <- rep(NA,simtime)
  I_F <- rep(NA,simtime)
  I_P <- rep(NA,simtime)
  D <- rep(NA,simtime)
  C_0 <- rep(NA,simtime)
  I_A0 <- rep(NA,simtime)
  B_P0 <- rep(NA,simtime)
  B_F0 <- rep(NA,simtime)
  
  A_S[1] <- AS0
  A_I[1] <- AI0
  F1[1] <- F0
  P[1] <- P0
  L[1] <- L0
  C_0[1] <- C0
  I_A0[1] <- IA0
  B_P0[1] <- BP0
  B_F0[1] <- BF0
  
  # parameters
  parms <- disc_parms
  
  s_A <- as.numeric(parms[parms$Parameter == "s_A", "Estimate"])
  g_S <- as.numeric(parms[parms$Parameter == "g_S", "Estimate"])
  g_I <- as.numeric(parms[parms$Parameter == "g_I", "Estimate"])
  p0 <- as.numeric(parms[parms$Parameter == "p0", "Estimate"])
  p1 <- as.numeric(parms[parms$Parameter == "p1", "Estimate"])
  c_A <- as.numeric(parms[parms$Parameter == "c_A", "Estimate"])
  b_A <- as.numeric(parms[parms$Parameter == "b_A", "Estimate"])
  e_A <- as.numeric(parms[parms$Parameter == "e_A", "Estimate"])
  gamma_A <- as.numeric(parms[parms$Parameter == "gamma_A", "Estimate"])
  
  s_P <- as.numeric(parms[parms$Parameter == "s_P", "Estimate"])
  g_P <- as.numeric(parms[parms$Parameter == "g_P", "Estimate"])
  c_F <- as.numeric(parms[parms$Parameter == "c_F", "Estimate"])
  c_P <- as.numeric(parms[parms$Parameter == "c_P", "Estimate"])
  b_F <- as.numeric(parms[parms$Parameter == "b_F", "Estimate"])
  b_P <- as.numeric(parms[parms$Parameter == "b_P", "Estimate"])
  e_P <- as.numeric(parms[parms$Parameter == "e_P", "Estimate"])
  gamma_P <- as.numeric(parms[parms$Parameter == "gamma_P", "Estimate"])
  l_P <- as.numeric(parms[parms$Parameter == "l_P", "Estimate"])
  l_B <- as.numeric(parms[parms$Parameter == "l_B", "Estimate"])
  
  d <- as.numeric(parms[parms$Parameter == "d", "Estimate"])
  h <- as.numeric(parms[parms$Parameter == "h", "Estimate"])
  
  grow_days <- seq(0, gs_days)
  
  # simulate population dynamics
  for(t in 1:(simtime - 1)){	
    
    # seedling establishment
    E_A <- e_A/(1 + gamma_A * L[t])
    E_P <- e_P/(1 + gamma_P * L[t])
    
    # initial conditions
    LogB_A0 <- ifelse((A_S[t] + A_I[t]) > 0, log(g_S * E_A * b_A * A_S[t] + g_I * E_A * b_A * A_I[t]), log(1e-100))
    LogB_F0 <- ifelse(F1[t] > 0, log(g_P * E_P * b_F * F1[t]), log(1e-100))
    LogB_P0 <- ifelse(B_P0[t] + B_F0[t] > 0, log(l_B * (B_P0[t] + B_F0[t])), log(1e-100))
    
    # biomass at the end of the growing season
    out <- ode(func = cont_mod_fun,
               y = c(LogB_A = LogB_A0,
                     LogB_F = LogB_F0,
                     LogB_P = LogB_P0,
                     I_A = 0, I_F = 0, I_P = 0, D = 0,
                     C = C_0[t] + h * I_A0[t]),
               times = grow_days,
               parms = con_parms) %>%
      as.data.frame()
    
    # modify output
    out2 <- out %>%
      as_tibble() %>%
      filter(time == gs_days) %>%
      mutate(B_A = exp(LogB_A),
             B_F = exp(LogB_F),
             B_P = exp(LogB_P),
             S_A = B_A - I_A,
             S_F = B_F - I_F,
             S_P = B_P - I_P) %>%
      select(-c(LogB_A, LogB_F, LogB_P))
    
    # save biomass
    B_A[t] <- as.numeric(out2$B_A)
    B_F[t] <- as.numeric(out2$B_F)
    B_P[t] <- as.numeric(out2$B_P)
    
    S_A[t] <- as.numeric(out2$S_A)
    S_F[t] <- as.numeric(out2$S_F)
    S_P[t] <- as.numeric(out2$S_P)
    
    I_A[t] <- as.numeric(out2$I_A)
    I_F[t] <- as.numeric(out2$I_F)
    I_P[t] <- as.numeric(out2$I_P)
    
    D[t] <- as.numeric(out2$D)
    
    # values for next year
    C_0[t+1] <- as.numeric(out2$C) # conidia
    I_A0[t+1] <- I_A[t] # conidia
    B_P0[t+1] <- B_P[t] # perennial biomass
    B_F0[t+1] <- B_F[t] # perennial biomass
    
    # correct to prevent negative/crazy small numbers
    B_A[t] = ifelse(B_A[t] < 1e-10, 0, B_A[t])
    B_F[t] = ifelse(B_F[t] < 1e-10, 0, B_F[t])
    B_P[t] = ifelse(B_P[t] < 1e-10, 0, B_P[t])
    
    S_A[t] = ifelse(S_A[t] < 1e-10, 0, S_A[t])
    S_F[t] = ifelse(S_F[t] < 1e-10, 0, S_F[t])
    S_P[t] = ifelse(S_P[t] < 1e-10, 0, S_P[t])
    
    I_A[t] = ifelse(I_A[t] < 1e-10, 0, I_A[t])
    I_F[t] = ifelse(I_F[t] < 1e-10, 0, I_F[t])
    I_P[t] = ifelse(I_P[t] < 1e-10, 0, I_P[t])
    
    D[t] = ifelse(D[t] < 1e-10, 0, D[t])
    C_0[t+1] = ifelse(C_0[t+1] < 1e-10, 0, C_0[t+1])
    I_A0[t+1] = ifelse(I_A0[t+1] < 1e-10, 0, I_A0[t+1])
    B_P0[t+1] = ifelse(B_P0[t+1] < 1e-10, 0, B_P0[t+1])
    B_F0[t+1] = ifelse(B_F0[t+1] < 1e-10, 0, B_F0[t+1])

    
    # proportion seeds infected
    p <- ifelse(B_A[t] > 0, exp(p0 + p1 * I_A[t]/B_A[t])/(1 + exp(p0 + p1 * I_A[t]/B_A[t])), 0)
    
    # population size
    A_S[t+1] = s_A * (1 - g_S) * A_S[t] +  B_A[t] * c_A * (1-p)
    A_I[t+1] = B_A[t] * c_A * p
    L[t+1] = (1 - d) * L[t] + B_A[t] + D[t]  
    F1[t+1] = s_P * (1 - g_P) * F1[t] + c_F * B_F[t] + c_P * B_P[t]
    P[t+1] = l_P * P[t] + g_P * E_P * l_P * F1[t]
    
    # correct to prevent negative numbers
    A_S[t+1] = ifelse(A_S[t+1] < 0, 0, A_S[t+1])
    A_I[t+1] = ifelse(A_I[t+1] < 0, 0, A_I[t+1])
    L[t+1] = ifelse(L[t+1] < 0, 0, L[t+1])
    F1[t+1] = ifelse(F1[t+1] < 0, 0, F1[t+1])
    P[t+1] = ifelse(P[t+1] < 0, 0, P[t+1])
    
  } 
  
  # last growing season
  # seedling establishment
    E_A <- e_A/(1 + gamma_A * L[simtime])
    E_P <- e_P/(1 + gamma_P * L[simtime])
    
    # initial conditions
    LogB_A0 <- ifelse((A_S[simtime] + A_I[simtime]) > 0, log(g_S * E_A * b_A * A_S[simtime] + g_I * E_A * b_A * A_I[simtime]), log(1e-100))
    LogB_F0 <- ifelse(F1[simtime] > 0, log(g_P * E_P * b_F * F1[simtime]), log(1e-100))
    LogB_P0 <- ifelse(B_P0[simtime] + B_F0[simtime] > 0, log(l_B * (B_P0[simtime] + B_F0[simtime])), log(1e-100))
    
    # biomass at the end of the growing season
    out3 <- ode(func = cont_mod_fun,
               y = c(LogB_A = LogB_A0,
                     LogB_F = LogB_F0,
                     LogB_P = LogB_P0,
                     I_A = 0, I_F = 0, I_P = 0, D = 0,
                     C = C_0[simtime] + h * I_A0[simtime]),
               times = grow_days,
               parms = con_parms) %>%
      as.data.frame()
    
    # modify output
    out4 <- out3 %>%
      as_tibble() %>%
      filter(time == gs_days) %>%
      mutate(B_A = exp(LogB_A),
             B_F = exp(LogB_F),
             B_P = exp(LogB_P),
             S_A = B_A - I_A,
             S_F = B_F - I_F,
             S_P = B_P - I_P) %>%
      select(-c(LogB_A, LogB_F, LogB_P))
    
    # save biomass
    B_A[simtime] <- as.numeric(out4$B_A)
    B_F[simtime] <- as.numeric(out4$B_F)
    B_P[simtime] <- as.numeric(out4$B_P)
    
    S_A[simtime] <- as.numeric(out4$S_A)
    S_F[simtime] <- as.numeric(out4$S_F)
    S_P[simtime] <- as.numeric(out4$S_P)
    
    I_A[simtime] <- as.numeric(out4$I_A)
    I_F[simtime] <- as.numeric(out4$I_F)
    I_P[simtime] <- as.numeric(out4$I_P)
    
  # total annual density
  A_T <- A_S + A_I
  
  # population data
  dfN <- tibble(time = rep(1:simtime, 16),
                species = rep(c("Susceptible annual",
                                "Infected annual",
                                "Annual",
                                "Perennial first-year", 
                                "Perennial adult", 
                                "Litter",
                                "Annual biomass",
                                "Perennial first-year biomass",
                                "Perennial adult biomass",
                                "Annual susceptible biomass",
                                "Perennial first-year susceptible biomass",
                                "Perennial adult susceptible biomass",
                                "Annual infected biomass",
                                "Perennial first-year infected biomass",
                                "Perennial adult infected biomass",
                                "Conidia"), 
                              each = simtime),
                N = c(A_S, A_I, A_T, F1, P, L, B_A, B_F, B_P, S_A, S_F, S_P, I_A, I_F, I_P, C_0))

  # return
  return(dfN)
}
```

### Annual alone
```{r A-only-discrete, echo = F}

# input values
modA <- disc_mod_fun(AS0 = 10, AI0 = 0, F0 = 0, P0 = 0, L0 = 0, C0 = as.numeric(parms[parms$Parameter == "h", "Estimate"]), IA0 = 0, BP0 = 0, BF0 = 0, simtime = 50, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modA %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modA %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modA %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```


### Perennial first-year alone
```{r F-only-discrete, echo = F}

# input values
modF <- disc_mod_fun(AS0 = 0, AI0 = 0, F0 = 10, P0 = 0, L0 = 0, C0 = as.numeric(parms[parms$Parameter == "h", "Estimate"]), IA0 = 0, BP0 = 0, BF0 = 0, simtime = 50, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modF %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modF %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modF %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```

### Perennial adult alone
```{r P-only-discrete, echo = F}

# input values
modP <- disc_mod_fun(AS0 = 0, AI0 = 0, F0 = 0, P0 = 10, L0 = 0, C0 = as.numeric(parms[parms$Parameter == "h", "Estimate"]), IA0 = 0, BP0 = as.numeric(parms[parms$Parameter == "b_P", "Estimate"]) * 10, BF0 = 0, simtime = 100, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modP %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modP %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modP %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```

### All species
```{r all-discrete, echo = F}

# input values
modT <- disc_mod_fun(AS0 = 10, AI0 = 0, F0 = 10, P0 = 10, L0 = 0, C0 = as.numeric(parms[parms$Parameter == "h", "Estimate"]), IA0 = 0, BP0 = as.numeric(parms[parms$Parameter == "b_P", "Estimate"]) * 10, BF0 = 0, simtime = 50, gs_days = 160, disc_parms = parms, con_parms = parms)

# create figure
modT %>%
  filter(species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

modT %>%
  filter(species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

modT %>%
  filter(species %in% c("Annual susceptible biomass", "Perennial first-year susceptible biomass", "Perennial adult susceptible biomass", "Annual infected biomass", "Perennial first-year infected biomass", "Perennial adult infected biomass") &
           !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')
```


# Long-term simulation

To simulate historical and future dynamics, we start with a community consisting of only the perennial species. The annual species invades after 100 years, but there are is no disease (i.e., $\beta_{Al} = \beta_{Fl} = \beta_{Pl} = 0$, which prevents initial infection, and $p = 0$). After 100 more years, the annual begins to spread disease within the community (i.e., $\beta_{Al} = \beta_{Fl} = \beta_{Pl} = 0.001$). We begin with 10 first-year perennials and later introduce 10 annuals. We introduce disease by infecting 1/10th of the annual biomass from the previous year.

```{r long-term simulation, echo = F}

# disease-free parms
parms_df <- parms %>%
  mutate(Estimate = case_when(Parameter %in% c("beta_AC", "beta_FC", "beta_PC", "p1") ~ 0,
                              Parameter == "p0" ~ -100,
                              TRUE ~ Estimate))

# perennial only
modL1 <- disc_mod_fun(AS0 = 0, AI0 = 0, F0 = 100, P0 = 0, L0 = 0, C0 = 0, IA0 = 0, BP0 = 0, BF0 = 0, simtime = 100, gs_days = 160,
                      disc_parms = parms_df, con_parms = parms_df)

# input values for next simulation
modL2_in <- modL1 %>%
  filter(time == max(time) &
           species %in% c("Perennial first-year", "Perennial adult", "Perennial adult biomass", "Perennial first-year biomass")) %>%
  select(-time) %>%
  pivot_wider(names_from = species,
              values_from = N) %>%
  rename(F0 = "Perennial first-year",
         P0 = "Perennial adult",
         BP0 = "Perennial adult biomass",
         BF0 = "Perennial first-year biomass")

# perennial only
modL2_per <- disc_mod_fun(AS0 = 0,
                      AI0 = 0,
                      F0 = modL2_in$F0,
                      P0 = modL2_in$P0,
                      L0 = 0,
                      C0 = 0,
                      IA0 = 0,
                      BP0 = modL2_in$BP0,
                      BF0 = modL2_in$BF0,
                      simtime = 100, gs_days = 160, disc_parms = parms_df, con_parms = parms_df)

# annual invades without disease
modL2_inv <- disc_mod_fun(AS0 = 10,
                      AI0 = 0,
                      F0 = modL2_in$F0,
                      P0 = modL2_in$P0,
                      L0 = 0,
                      C0 = 0,
                      IA0 = 0,
                      BP0 = modL2_in$BP0,
                      BF0 = modL2_in$BF0,
                      simtime = 100, gs_days = 160, disc_parms = parms_df, con_parms = parms_df)

# input values for next simulation
modL3_in_per <- modL2_per %>%
  filter(time == max(time) &
           species %in% c("Perennial first-year", "Perennial adult", "Perennial adult biomass", "Perennial first-year biomass")) %>%
  select(-time) %>%
  pivot_wider(names_from = species,
              values_from = N) %>%
  rename(F0 = "Perennial first-year",
         P0 = "Perennial adult",
         BP0 = "Perennial adult biomass",
         BF0 = "Perennial first-year biomass")

modL3_in_inv <- modL2_inv %>%
  filter(time == max(time) &
           species %in% c("Susceptible annual", "Infected annual", "Perennial first-year", "Perennial adult", "Litter", "Annual biomass", "Perennial adult biomass", "Perennial first-year biomass")) %>%
  select(-time) %>%
  pivot_wider(names_from = species,
              values_from = N) %>%
  rename(AS0 = "Susceptible annual",
         AI0 = "Infected annual",
         F0 = "Perennial first-year",
         P0 = "Perennial adult",
         L0 = "Litter",
         BA = "Annual biomass",
         BP0 = "Perennial adult biomass",
         BF0 = "Perennial first-year biomass")

# parameters with disease competition coefficients
parms_d <- parms %>%
  filter(!Parameter %in% c("alpha_AA", "alpha_AF", "alpha_AP", "alpha_FA", "alpha_FF", "alpha_FP", "alpha_PA", "alpha_PF", "alpha_PP")) %>%
  mutate(Parameter = str_replace(Parameter, "_dis", ""))

# perennial only
modL3_per <- disc_mod_fun(AS0 = 0,
                      AI0 = 0,
                      F0 = modL3_in_per$F0,
                      P0 = modL3_in_per$P0,
                      L0 = 0,
                      C = 0,
                      IA0 = 0,
                      BP0 = modL3_in_per$BP0,
                      BF0 = modL3_in_per$BF0,
                      simtime = 100, gs_days = 160, disc_parms = parms_df, con_parms = parms_df)

# invasion only
modL3_inv <- disc_mod_fun(AS0 = modL3_in_inv$AS0,
                      AI0 = 0,
                      F0 = modL3_in_inv$F0,
                      P0 = modL3_in_inv$P0,
                      L0 = modL3_in_inv$L0,
                      C = 0,
                      IA0 = 0,
                      BP0 = modL3_in_inv$BP0,
                      BF0 = modL3_in_inv$BF0,
                      simtime = 100, gs_days = 160, disc_parms = parms_df, con_parms = parms_df)

# disease appears
modL3_dis <- disc_mod_fun(AS0 = modL3_in_inv$AS0,
                      AI0 = modL3_in_inv$AI0,
                      F0 = modL3_in_inv$F0,
                      P0 = modL3_in_inv$P0,
                      L0 = modL3_in_inv$L0,
                      C = as.numeric(parms[parms$Parameter == "h", "Estimate"]),
                      IA0 = 0,
                      BP0 = modL3_in_inv$BP0,
                      BF0 = modL3_in_inv$BF0,
                      simtime = 100, gs_days = 160, disc_parms = parms_d, con_parms = parms_d)

# combine
modL <- modL1 %>%
  full_join(modL2_per %>%
              mutate(time = time + 100)) %>%
  full_join(modL3_per %>%
              mutate(time = time + 200)) %>%
  mutate(scenario = "Ev alone") %>%
  full_join(modL2_inv %>%
              mutate(time = time + 100,
                     scenario = "invasion")) %>%
  full_join(modL3_inv %>%
              mutate(time = time + 200,
                     scenario = "invasion")) %>%
  full_join(modL3_dis %>%
              mutate(time = time + 200,
                     scenario = "disease"))

# save dataset
write_csv(modL, "../output/discrete_continuous_model_time_series.csv")
# modL <- read_csv("../output/discrete_continuous_model_time_series.csv")
```
# Long-term simulation figure
```{r figure}

# changes to add
# per meter squared on axes
# annotations for events
# include litter in Mv biomass to explain spike

# figure settings
fig_theme <- theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size = 8, color = "black"),
        axis.text.x = element_text(size = 8, color = "black"),
        axis.title.y = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.background = element_blank(),
        legend.key = element_rect(fill = NA),
        legend.margin = margin(-0.1, -0.1, -0.1, -0.1, unit = "cm"),
        plot.title = element_text(size = 8, hjust = 0.2),
        strip.text = element_text(size = 8, hjust = 0.2),
        strip.background = element_blank())

linePal = c("solid", "dashed", "dotted")
colPal = c("#55C667FF", "#238A8DFF", "#404788FF")

# format data
modL_fig_dat <- modL %>%
  filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
  group_by(time, scenario) %>%
  mutate(totBio = sum(N)) %>%
  ungroup() %>%
  mutate(N = N/totBio,
         plant_type = "Relative biomass") %>%
  select(-totBio) %>%
  full_join(modL %>%
              filter(species %in% c("Perennial first-year biomass", "Perennial adult biomass")) %>%
              mutate(plant_type = "Ev biomass")) %>%
    full_join(modL %>%
              filter(species == "Annual biomass") %>%
              mutate(plant_type = "Mv biomass")) %>%
    full_join(modL %>%
              filter(species %in% c("Perennial first-year", "Perennial adult")) %>%
              mutate(plant_type = "Ev density")) %>%
  full_join(modL %>%
              filter(species == "Annual") %>%
              mutate(plant_type = "Mv density")) %>%
  mutate(plant_group = case_when(species %in%  c("Annual", "Annual biomass") ~ "Mv",
                                 species %in%  c("Perennial first-year", "Perennial first-year biomass") ~ "first-\nyear Ev",
                                 species %in%  c("Perennial adult", "Perennial adult biomass") ~ "adult Ev"),
         scenario = fct_relevel(scenario, "Ev alone", "invasion"))

# relative biomass
rel_bio_fig <- ggplot(filter(modL_fig_dat, plant_type == "Relative biomass"),
       aes(x = time, y = N, color = plant_group, linetype = scenario)) +
  geom_line() +
  scale_color_manual(name = "Plant group", values = colPal) +
  scale_linetype_manual(name = "Scenario", values = linePal) +
  fig_theme

# figure for legend
leg <- get_legend(rel_bio_fig)

# Ev biomass
ev_bio_fig <- ggplot(filter(modL_fig_dat, plant_type == "Ev biomass"), 
       aes(x = time, y = N, color = plant_group, linetype = scenario)) +
  geom_rect(xmin = 100, xmax = 200, ymin = -Inf, ymax = Inf, fill = "gray95", color = NA, show.legend = F) +
  geom_rect(xmin = 200, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "gray75", color = NA, show.legend = F) +
  geom_line(size = 0.8) +
  scale_color_manual(name = "Plant group", values = colPal[1:2]) +
  scale_linetype_manual(name = "Scenario", values = linePal) +
  ylab("Biomass (g)") +
  fig_theme +
  theme(axis.title.x = element_blank(),
        legend.position = "none")

# Mv biomass
mv_bio_fig <- ev_bio_fig %+%
  filter(modL_fig_dat, plant_type == "Mv biomass") +
  scale_color_manual(name = "Plant group", values = colPal[3]) +
  theme(axis.title.y = element_blank())

# Ev density
ev_dens_fig <- ev_bio_fig %+%
  filter(modL_fig_dat, plant_type == "Ev density") +
  ylab("Density") +
  xlab("Time (years)") +
  theme(axis.title.x = element_text(size = 10))

# Mv density
mv_dens_fig <- ev_dens_fig %+%
  filter(modL_fig_dat, plant_type == "Mv density") +
  scale_color_manual(name = "Plant group", values = colPal[3]) +
  xlab("Time (years)") +
  theme(axis.title.y = element_blank())

# combine
combo_fig <- plot_grid(ev_bio_fig, mv_bio_fig,
          ev_dens_fig, mv_dens_fig,
          nrow = 2,
          labels = LETTERS[1:4])

plot_grid(combo_fig, leg,
          nrow = 1,
          rel_widths = c(1, 0.3))

rel_bio_fig

```
# Sensitivity analysis
### https://daphnia.ecology.uga.edu/drakelab/wp-content/uploads/2016/07/sismid-lhs-lecture.pdf


# Virulence simulation
```{r virulence simulation}

# virulence values
vir <- seq(0, 0.03, length.out = 10)
vir[1] <- 1e-20 # make first value non-zero


# empty list
outV <- vector(mode = "list", length = length(vir))

# cycle through virulence
for(i in 1:length(vir)){

  # set virulence value
  parms_d_v <- parms_d %>%
    mutate(Estimate = case_when(Parameter == "v_A" ~ vir[i],
                                TRUE ~ Estimate))
  # simulation
  modV <- disc_mod_fun(AS0 = modL3_in$AS0,
                       AI0 = modL3_in$AI0,
                       F0 = modL3_in$F0,
                       P0 = modL3_in$P0,
                       L0 = modL3_in$L0,
                       C = as.numeric(parms[parms$Parameter == "h", "Estimate"]),
                       IA0 = 0,
                       simtime = 100, gs_days = 160, disc_parms = parms_d_v, con_parms = parms_d_v)

  # save data table
  outV[[i]] <- modV %>%
    mutate(virulence = vir[i])
  }

# collapse list
outV2 <- outV %>%
  bind_rows() %>%
  filter(time == max(time))

# save dataset
write_csv(outV2, "../output/discrete_continous_model_virulence_simulation.csv")

# import data
# outV2 <- read_csv("../output/discrete_continous_model_virulence_simulation.csv")

# figure
filter(outV2, species %in% c("Susceptible annual", "Infected annual", "Annual", "Perennial first-year", "Perennial adult") & !is.na(N)) %>%
  ggplot(aes(x = virulence, y = log(N), color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Annual virulence', y='Number of plants')

filter(outV2, species %in% c("Litter", "Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") & !is.na(N)) %>%
  ggplot(aes(x = virulence, y = log(N), color = species)) +
  geom_line() +
  theme_classic() +
  labs(x='Annual virulence', y='Biomass (g)')
```

# Biomass loss
```{r biomass loss}

# biomass loss with increased virulence
outV2 %>%
  filter(species == "Annual biomass") %>%
  mutate(N_v0 = outV2 %>% filter(species == "Annual biomass" & virulence < 1e-10) %>% pull(N),
         disease_change = (N_v0 - N) / N_v0) %>%
  ggplot(aes(virulence, disease_change)) +
  geom_line()

```

# Virulence/transmission simulation
```{r virulence transmission simulation}

# virulence and transmission values
# valsVB <- tibble(vir = c(1e-20, 0.00667, 0.00667*2, 0.00667*3)) %>%
#   expand_grid(tibble(beta = c(0.038, 0.038*2, 0.038*3)))
# 
# # empty list
# outVB <- vector(mode = "list", length = nrow(valsVB))
# 
# # cycle through virulence
# for(i in 1:nrow(valsVB)){
# 
#   # set virulence value
#   parms_in <- parms %>%
#     mutate(Estimate = case_when(Parameter == "v_A" ~ valsVB$vir[i],
#                                 Parameter == "beta_AA" ~ valsVB$beta[i],
#                                 TRUE ~ Estimate))
#   # simulation
#   modVB <- disc_mod_fun(AS0 = modL3_in$AS0,
#                        AI0 = modL3_in$AI0,
#                        F0 = modL3_in$F0,
#                        P0 = modL3_in$P0,
#                        L0 = modL3_in$L0,
#                        IA0 = modL3_in$BA/10,
#                        simtime = 100, gs_days = 160, disc_parms = parms_in, con_parms = parms_in)
# 
#   # save data table
#   outVB[[i]] <- modVB %>%
#     mutate(virulence = valsVB$vir[i],
#            transmission = valsVB$beta[i])
#   }
# 
# # collapse list
# outVB2 <- outVB %>%
#   bind_rows()

# import data
outVB2 <- read_csv("../output/discrete_continous_model_virulence_transmission_simulation.csv")

# figure
filter(outVB2, species %in% c("Annual", "Perennial first-year", "Perennial adult") & !is.na(N)) %>%
  ggplot(aes(x = time, y = N, color = as.factor(round(virulence, 3)), linetype = as.factor(transmission))) +
  geom_line() +
  facet_wrap(~ species) +
  theme_classic() +
  labs(x='Time (years)', y='Number of plants')

filter(outVB2, species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
  ggplot(aes(x = time, y = N, color = as.factor(round(virulence, 3)), linetype = as.factor(transmission))) +
  geom_line() +
  facet_wrap(~ species) +
  theme_classic() +
  labs(x='Time (years)', y='Biomass (g)')

# # save dataset
# write_csv(outVB2, "../output/discrete_continous_model_virulence_transmission_simulation.csv")

```

# Figure
```{r figure}

# figure settings
fig_theme <- theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size = 8, color = "black"),
        axis.text.x = element_text(size = 8, color = "black"),
        axis.title.y = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        legend.background = element_blank(),
        legend.key = element_rect(fill = NA),
        legend.position = "none",
        legend.margin = margin(-0.1, 0, 0.2, 2, unit = "cm"),
        plot.title = element_text(size = 8, hjust = 0.2),
        strip.text = element_text(size = 8, hjust = 0.2),
        strip.background = element_blank())

linePal = c("solid", "dashed", "solid")

# edit data
# timeDensDat <- modL %>%
#   filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev"))
# 
# timeBioDat <- modL %>%
#   filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev")) %>%
#   group_by(time) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)
# 
# virDensDat <- outV2 %>%
#   filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev"))
# 
# virBioDat <- outV2 %>%
#   filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev")) %>%
#   group_by(virulence) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)
# 
# timeVirDat <- outV %>%
#   bind_rows() %>%
#   filter(virulence == virBioDat %>%
#            filter(species == "Annual biomass") %>%
#            filter(N == min(N)) %>%
#            pull(virulence)) %>%
#   mutate(time = time + 200)
# 
# timeVirBioDat <- timeVirDat %>%
#   full_join(modL %>%
#               filter(time < 200)) %>%
#   filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev")) %>%
#   group_by(time) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)
# 
# timeVirDensDat <- timeVirDat %>%
#     full_join(modL %>%
#               filter(time < 200)) %>%
#   filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev")) 
# 
# virTransDensDat <- outVB2 %>%
#   filter(time >= (max(time) - 50) & species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
#   group_by(species, virulence, transmission) %>%
#   summarise(N = mean(N)) %>%
#   ungroup() %>%
#   mutate(plant_group = case_when(species == "Annual" ~ "Mv",
#                                  species == "Perennial first-year" ~ "first-year Ev",
#                                  species == "Perennial adult" ~ "adult Ev"),
#          virulence_abb = round(virulence, 3),
#          transmission_abb = round(transmission, 3),
#          virulenceF = case_when(virulence_abb == 0.000 ~ "observed",
#                                 virulence_abb == 0.007 ~ "previous studies",
#                                 virulence_abb == 0.013 ~ "2x previous",
#                                 virulence_abb == 0.020 ~ "3x previous") %>%
#            fct_relevel("observed", "previous studies"),
#          transmissionF = case_when(transmission_abb == 0.038 ~ "observed Mv transmission",
#                                    transmission_abb == 0.076 ~ "2x obs. Mv transmission",
#                                    transmission_abb == 0.114 ~ "3x obs. Mv transmission") %>%
#            fct_relevel("observed Mv transmission")) 
# 
# virTransBioDat <- outVB2 %>%
#   filter(time >= (max(time) - 50) & species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
#   group_by(species, virulence, transmission) %>%
#   summarise(N = mean(N)) %>%
#   ungroup() %>%
#   mutate(plant_group = case_when(species == "Annual biomass" ~ "Mv",
#                                  species == "Perennial first-year biomass" ~ "first-year Ev",
#                                  species == "Perennial adult biomass" ~ "adult Ev"),
#          virulence_abb = round(virulence, 3),
#          transmission_abb = round(transmission, 3),
#          virulenceF = case_when(virulence_abb == 0.000 ~ "observed",
#                                 virulence_abb == 0.007 ~ "previous studies",
#                                 virulence_abb == 0.013 ~ "2x previous",
#                                 virulence_abb == 0.020 ~ "3x previous") %>%
#            fct_relevel("observed", "previous studies"),
#          transmissionF = case_when(transmission_abb == 0.038 ~ "observed Mv transmission",
#                                    transmission_abb == 0.076 ~ "2x obs. Mv transmission",
#                                    transmission_abb == 0.114 ~ "3x obs. Mv transmission") %>%
#            fct_relevel("observed Mv transmission")) %>%
#   group_by(transmissionF, virulenceF) %>%
#   mutate(tot = sum(N)) %>%
#   ungroup() %>%
#   mutate(relBio = N/tot)

# virulence/transmission time series
outVB3 <- outVB2 %>%
  mutate(time = time + 200) %>%
  mutate(virulence_abb = round(virulence, 3),
         transmission_abb = round(transmission, 3),
         virulenceF = case_when(virulence_abb == 0.000 ~ "observed",
                                virulence_abb == 0.007 ~ "previous studies",
                                virulence_abb == 0.013 ~ "2x previous",
                                virulence_abb == 0.020 ~ "3x previous") %>%
           fct_relevel("observed", "previous studies"),
         transmissionF = case_when(transmission_abb == 0.038 ~ "observed Mv transmission",
                                   transmission_abb == 0.076 ~ "2x obs. Mv transmission",
                                   transmission_abb == 0.114 ~ "3x obs. Mv transmission") %>%
           fct_relevel("observed Mv transmission")) %>%
  filter((virulenceF == "observed" & transmissionF == "observed Mv transmission") |
           (virulenceF == "previous studies" & transmissionF == "observed Mv transmission") |
           (virulenceF == "3x previous" & transmissionF == "3x obs. Mv transmission")) %>%
  mutate(virTranF = case_when(virulenceF == "observed" ~ "Experiment\nvirulence & transmission",
                              virulenceF == "previous studies" ~ "Max observed\nvirulence & transmission",
                              virulenceF == "3x previous" ~ "3x max observed\nvirulence & transmission"),
         plant_type = case_when(species %in% c("Annual", "Perennial first-year", "Perennial adult") ~ "Density",
                                species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass") ~ "Relative biomass")) %>%
  filter(!is.na(plant_type))

# calculate relative biomass
outVB4 <- outVB3 %>%
  filter(plant_type == "Relative biomass") %>%
  group_by(time, virTranF) %>%
  mutate(totBio = sum(N)) %>%
  ungroup() %>%
  mutate(N = N/totBio) %>%
  select(-totBio) %>%
  full_join(outVB3 %>%
              filter(plant_type == "Density"))

# format first 200 years
modVB4 <- modL %>%
  filter(species %in% c("Annual biomass", "Perennial first-year biomass", "Perennial adult biomass")) %>%
  group_by(time) %>%
  mutate(totBio = sum(N)) %>%
  ungroup() %>%
  mutate(N = N/totBio,
         plant_type = "Relative biomass") %>%
  select(-totBio) %>%
  full_join(modL %>%
              filter(species %in% c("Annual", "Perennial first-year", "Perennial adult")) %>%
              mutate(plant_type = "Density"))

# combine with first 200 years
timeVirTransDat <- outVB4 %>%
  full_join(modVB4 %>%
              filter(time < 201) %>%
              expand_grid(outVB4 %>%
                            select(virTranF) %>%
                            unique())) %>%
  mutate(plant_group = case_when(species %in%  c("Annual", "Annual biomass") ~ "Mv",
                                 species %in%  c("Perennial first-year", "Perennial first-year biomass") ~ "first-\nyear Ev",
                                 species %in%  c("Perennial adult", "Perennial adult biomass") ~ "adult Ev"),
         virTranF =  fct_relevel(virTranF, "Experiment\nvirulence & transmission", "Max observed\nvirulence & transmission")) 

# text
timeVirTransText <- timeVirTransDat %>%
  filter(plant_type == "Density")  %>%
  filter(time %in% c(100, 200) & plant_group == "Mv") %>%
  mutate(label = case_when(time == 100 ~ "invasion\noccurs",
                           time == 200 ~ "disease\nemerges"),
         N = 3600)

# virulence/transmission time series
tiff("../output/discrete_continuous_model_time_series_virulence_transmission.tiff", width = 18, height = 11, units = "cm", res = 300)
ggplot(timeVirTransDat, aes(x = time, y = N)) +
  geom_rect(xmin = 100, xmax = 200, ymin = -Inf, ymax = Inf, fill = "gray95", color = NA, show.legend = F) +
  geom_rect(xmin = 200, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "gray75", color = NA, show.legend = F) +
  geom_line(aes(linetype = plant_group, color = plant_group), size = 0.8) +
  geom_text(data = timeVirTransText, aes(label = label), color = "black", size = 2.5, hjust = 0, vjust = 0.6, lineheight = 0.6) +
  facet_grid(plant_type ~ virTranF, scales = "free", switch = "y") +
  scale_color_viridis_d(name = "Plant group", end = 0.7, direction = -1) +
  scale_linetype_manual(name = "Plant group", values = linePal) +
  xlab("Time (years)") +
  fig_theme +
  theme(strip.placement = "outside",
        strip.text = element_text(size = 10, hjust = 0.5),
        axis.title.y = element_blank(),
        legend.position = c(-0.005, 0.85))
dev.off()

# # time series figures
# timeDensFig <- timeDensDat %>%
#   ggplot(aes(x = time, y = N, color = plant_group, linetype = plant_group)) +
#   geom_rect(xmin = 250, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "light gray", color = NA, show.legend = F) +
#   geom_line(size = 1.5) +
#   annotate("text", x = 100, y = 0, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0, label = "invasion occurs", hjust = 0, size = 2.5) +
#   annotate("text", x = 200, y = 3197, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 2900, label = "disease emerges", vjust = 1, size = 2.5) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = expression(paste('Density (', m^-2, ')', sep = "")), title = 'Observed Mv virulence and transmission') +
#   fig_theme +
#   theme(legend.position = c(0.04, 0.7))
# 
# tiff("../output/discrete_continuous_model_time_series_density_figure.tiff", width = 3, height = 3, units = "in", res = 300)
# timeDensFig +
#   theme(legend.position = "none")
# dev.off()
# 
# tiff("../output/discrete_continuous_model_time_series_legend_figure.tiff", width = 5, height = 5, units = "in", res = 300)
# timeDensFig +
#   scale_color_viridis_d(name = "Plant group:", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group:") +
#   theme(legend.position = "bottom",
#         legend.direction = "horizontal",
#         legend.key.width = unit(1.5, "cm"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title.y = element_blank())
# dev.off()
# 
# timeBioFig <- timeBioDat %>%
#   ggplot(aes(x = time, y = relBio, color = plant_group, linetype = plant_group)) +
#   geom_rect(xmin = 250, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "light gray", color = NA, show.legend = F) +
#   geom_line(size = 1.5) +
#   annotate("text", x = 100, y = 0.05, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0.05, label = "invasion occurs", hjust = 0, size = 2.5) +
#   annotate("text", x = 200, y = 0.882, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 0.8, label = "disease emerges", vjust = 1, size = 2.5) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = 'Proportional biomass', title = 'Observed Mv virulence and transmission') +
#   fig_theme
# 
# tiff("../output/discrete_continuous_model_time_series_rel_bio_figure.tiff", width = 3, height = 3, units = "in", res = 300)
# timeBioFig
# dev.off()
# 
# # virulence figures
# virDensFig <- virDensDat %>%
#   ggplot(aes(x = virulence, y = N, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = expression(paste('Mv virulence (', day^-1, ')', sep = "")), y = expression(paste('Final density (', m^-2, ')', sep = ""))) +
#   fig_theme
# 
# virBioFig <- virBioDat %>%
#   ggplot(aes(x = virulence, y = relBio, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = expression(paste('Mv virulence (', day^-1, ')', sep = "")), y = 'Final relative biomass') +
#   fig_theme
# 
# tiff("../output/discrete_continuous_model_time_series_virulence_figure.tiff", width = 7, height = 5, units = "in", res = 300)
# plot_grid(timeDensFig, timeBioFig, virDensFig, virBioFig,
#           nrow = 2,
#           labels = LETTERS[1:4])
# dev.off()
# 
# # high virulence time series figures
# timeVirDensFig <- timeVirDensDat %>%
#   ggplot(aes(x = time, y = N, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   annotate("text", x = 100, y = 0, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0, label = "invasion occurs", hjust = 0, size = 2) +
#   annotate("text", x = 200, y = 3197, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 2900, label = "disease emerges", vjust = 1, size = 2) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = expression(paste('Density (', m^-2, ')', sep = "")), title = "Virulence in previous studies") +
#   fig_theme
# 
# timeVirBioFig <- timeVirBioDat %>%
#   ggplot(aes(x = time, y = relBio, color = plant_group, linetype = plant_group)) +
#   geom_line() +
#   annotate("text", x = 100, y = 0.05, label = sprintf('\u2190'), hjust = 0) +
#   annotate("text", x = 120, y = 0.05, label = "invasion occurs", hjust = 0, size = 2) +
#   annotate("text", x = 200, y = 0.882, label = sprintf('\u2191'), vjust = 1) +
#   annotate("text", x = 200, y = 0.8, label = "disease emerges", vjust = 1, size = 2) +
#   scale_color_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   scale_linetype_manual(values = linePal, name = "Plant group") +
#   labs(x = 'Time (years)', y = 'Relative biomass') +
#   fig_theme
# 
# tiff("../output/discrete_continuous_model_time_series_multi_panel_figure.tiff", width = 7, height = 5, units = "in", res = 300)
# plot_grid(timeDensFig + ggtitle("Virulence in this study"), timeBioFig, timeVirDensFig, timeVirBioFig,
#           nrow = 2,
#           labels = LETTERS[1:4])
# dev.off()
# 
# # virulence/transmission combinations
# tiff("../output/discrete_continuous_model_virulence_transmission_density_figure.tiff", width = 2, height = 3, units = "in", res = 300)
# ggplot(virTransDensDat, aes(x = virulenceF, y = N, fill = plant_group)) +
#   geom_bar(stat = "identity") +
#   facet_wrap(~ transmissionF, ncol = 1) +
#   scale_fill_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   labs(x = 'Mv virulence') +
#   scale_y_continuous(breaks = c(0, 1500, 3000)) +
#   fig_theme +
#   theme(axis.text.x = element_text(size = 8, color = "black", angle = 30, hjust = 1, vjust = 1),
#         axis.title.y = element_blank())
# dev.off()
# 
# tiff("../output/discrete_continuous_model_virulence_transmission_rel_bio_figure.tiff", width = 2, height = 3, units = "in", res = 300)
# ggplot(virTransBioDat, aes(x = virulenceF, y = relBio, fill = plant_group)) +
#   geom_bar(stat = "identity") +
#   facet_wrap(~ transmissionF, ncol = 1) +
#   scale_fill_viridis_d(name = "Plant group", end = 0.8, direction = -1) +
#   labs(x = 'Mv virulence') +
#   scale_y_continuous(breaks = c(0, 0.5, 1)) +
#   fig_theme +
#   theme(axis.text.x = element_text(size = 8, color = "black", angle = 30, hjust = 1, vjust = 1),
#         axis.title.y = element_blank())
# dev.off()

# text values
timeDensDat %>% 
  filter(species %in% c("Perennial adult", "Perennial first-year") & time %in% c(100, 200)) %>%
  group_by(time) %>%
  summarise(N = sum(N))

timeBioDat %>% 
  filter(species %in% c("Perennial adult biomass", "Perennial first-year biomass") & time %in% c(100, 200, 300)) %>%
  group_by(time) %>%
  summarise(relBio = sum(relBio),
            bio = sum(N))

timeDensDat %>%
  filter(species == "Annual" & time %in% c(200, 300))

timeBioDat %>%
  filter(species == "Annual biomass" & time %in% c(200, 300))

virDensDat %>%
  filter(virulence == min(virulence) | N == min(N) | virulence == max(virulence))

virBioDat %>%
  filter(species %in% c("Perennial adult biomass", "Perennial first-year biomass")) %>%
  filter(round(virulence, 4) %in% c(0.0000, 0.0067)) %>%
  group_by(virulence) %>%
  summarise(relBio = sum(relBio),
            bio = sum(N))

virBioDat %>%
  filter(species == "Annual biomass") %>%
  filter(N == min(N)) %>%
  mutate(treatment = "control") %>%
  full_join(timeBioDat %>%
              filter(species == "Annual biomass" & time == 200) %>%
              mutate(treatment = "fungicide")) %>%
  select(treatment, N) %>%
  pivot_wider(names_from = treatment,
              values_from = N) %>%
  mutate(prop = (fungicide - control)/control)

virTransBioDat %>%
  filter(virulenceF == "3x previous" & transmissionF == "3x obs. Mv transmission" & plant_group != "Mv") %>%
  summarise(relBio = sum(relBio))
```

